(()=>{"use strict";var e={418:(e,t,s)=>{function a(e,t,s=[]){return t?s&&0!==s.length?(console.log("[QUESTION_JUDGE] ✅ 기존 대화 존재 - 추가 질문으로 판별"),console.log("[QUESTION_JUDGE] - 대화 ID:",t),console.log("[QUESTION_JUDGE] - 히스토리 메시지 수:",s.length),{isFirstQuestion:!1,questionType:"followup",apiEndpoint:"/api/normal_llm/langgraph/followup/stream",reason:"기존 대화의 추가 질문"}):(console.log("[QUESTION_JUDGE] ✅ 빈 히스토리 - 최초 질문으로 판별"),{isFirstQuestion:!0,questionType:"first",apiEndpoint:"/api/langgraph/stream",reason:"빈 대화 히스토리"}):{isFirstQuestion:!0,questionType:"first",apiEndpoint:"/api/langgraph/stream",reason:"새 대화"}}async function o(e,t,s=[],o={}){console.log("[QUESTION_ROUTER] 질문 라우팅 시작");const r=a(e,t,s);console.log("[QUESTION_ROUTER] 판별 결과:",r);const n={question:e,conversation_id:t,generate_image:o.generateImage||!1,include_langgraph_context:!r.isFirstQuestion,langgraph_context:r.isFirstQuestion?null:{documents:s.filter((e=>e.langgraph_result?.documents)).flatMap((e=>e.langgraph_result.documents)).slice(0,5)}};console.log("[QUESTION_ROUTER] 요청 데이터:",n),console.log("[QUESTION_ROUTER] API 엔드포인트:",r.apiEndpoint);try{const e=await fetch(r.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")||""}`},body:JSON.stringify(n)});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return console.log("[QUESTION_ROUTER] ✅ API 요청 성공"),{response:e,judgment:r,requestData:n}}catch(i){throw console.error("[QUESTION_ROUTER] ❌ API 요청 실패:",i),i}}function r(e){console.log("[CONTEXT_EXTRACTOR] LangGraph 컨텍스트 추출 시작");const t={documents:[],keywords:[],hasSearchResults:!1};if(!e||0===e.length)return console.log("[CONTEXT_EXTRACTOR] 빈 히스토리"),t;for(const a of e)if(a.langgraph_result?.documents&&(t.documents.push(...a.langgraph_result.documents),t.hasSearchResults=!0),a.keyword)try{const e="string"===typeof a.keyword?JSON.parse(a.keyword):a.keyword;Array.isArray(e)&&t.keywords.push(...e)}catch(s){console.warn("[CONTEXT_EXTRACTOR] 키워드 파싱 실패:",s)}return t.documents=t.documents.slice(0,5),t.keywords=[...new Set(t.keywords)].slice(0,10),console.log("[CONTEXT_EXTRACTOR] 추출된 컨텍스트:",{documentsCount:t.documents.length,keywordsCount:t.keywords.length,hasSearchResults:t.hasSearchResults}),t}function n(e,t){console.log("[UI_UPDATER] UI 업데이트 시작:",e),e.isFirstQuestion?t({showLangGraphProgress:!0,showSearchResults:!0,questionType:"first",statusMessage:"RAG 검색 및 분석을 진행합니다..."}):t({showLangGraphProgress:!1,showSearchResults:!1,questionType:"followup",statusMessage:"이전 대화 맥락을 고려하여 답변합니다..."})}function i(e,t){return console.error("[ERROR_HANDLER] 질문 처리 오류:",e),t.isFirstQuestion&&e.message.includes("langgraph")?(console.log("[ERROR_HANDLER] LangGraph 실패 - 일반 LLM으로 폴백"),{...t,isFirstQuestion:!1,questionType:"fallback",apiEndpoint:"/api/chat/stream",reason:"LangGraph 실패로 인한 폴백"}):{error:e.message,fallback:!0,apiEndpoint:"/api/chat/stream"}}s.r(t),s.d(t,{default:()=>l,extractLangGraphContext:()=>r,handleQuestionError:()=>i,judgeQuestionType:()=>a,sendQuestionToAppropriateEndpoint:()=>o,updateUIForQuestionType:()=>n});const l={judgeQuestionType:a,sendQuestionToAppropriateEndpoint:o,extractLangGraphContext:r,updateUIForQuestionType:n,handleQuestionError:i}},518:(e,t,s)=>{var a=s(130),o=s(782),r=s(387),n=s(768),i=s(232);const l={class:"sidebar"},c={class:"sidebar-controls"},u={class:"conversations-list"},g=["onClick"],d={class:"conversation-icon"},h={class:"conversation-content"},p={class:"conversation-actions"},m=["onClick"],v={class:"main"},w={class:"header"},k={class:"user-avatar"},f={key:0,class:"user-initial"},y={key:1,class:"user-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},S={key:0,class:"user-popup"},C={class:"user-popup-header"},_={class:"user-popup-info"},I={class:"user-popup-name"},b={class:"user-popup-email"},L={class:"user-popup-email"},A={class:"user-popup-menu"},$={class:"modal-container"},T={class:"modal-header"},E={class:"modal-body"},R={class:"form-group"},x={key:0,class:"error-message"},O={key:1,class:"api-key-status"},U={class:"modal-footer"},M=["disabled"],P={class:"modal-container"},D={class:"modal-header"},N={class:"modal-body"},K={class:"form-group"},F={class:"form-group"},B={class:"form-group"},j={class:"modal-footer"},Q=["disabled"];function J(e,t,s,o,r,J){const X=(0,n.g2)("router-view");return(0,n.uX)(),(0,n.CE)("div",{class:(0,i.C4)(["app",{"dark-mode":!0,"collapsed-sidebar":r.isSidebarCollapsed}])},[(0,n.Lk)("aside",l,[(0,n.Lk)("div",c,[(0,n.Lk)("div",{class:"new-chat-btn",onClick:t[0]||(t[0]=(...e)=>J.newConversation&&J.newConversation(...e))},t[16]||(t[16]=[(0,n.Lk)("svg",{class:"btn-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),(0,n.Lk)("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})],-1)])),(0,n.Lk)("div",{class:"toggle-sidebar-btn",onClick:t[1]||(t[1]=(...e)=>J.toggleSidebar&&J.toggleSidebar(...e))},t[17]||(t[17]=[(0,n.Lk)("svg",{class:"toggle-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),(0,n.Lk)("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),(0,n.Lk)("line",{x1:"3",y1:"18",x2:"21",y2:"18"})],-1)]))]),(0,n.Lk)("div",u,[(0,n.bF)(a.F,{name:"list"},{default:(0,n.k6)((()=>[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(e.$store.state.conversations,(s=>((0,n.uX)(),(0,n.CE)("div",{key:s.id||`temp-${s.created_at}`,class:(0,i.C4)(["conversation-item",{active:e.$store.state.currentConversation&&s.id===e.$store.state.currentConversation.id}]),onClick:e=>J.selectConversation(s)},[(0,n.Lk)("div",d,(0,i.v_)(J.getConversationIcon(s.icon_type)),1),(0,n.Lk)("div",h,(0,i.v_)(J.getConversationTitle(s)),1),(0,n.Lk)("div",p,[(0,n.Lk)("button",{class:"delete-btn",onClick:(0,a.D$)((e=>J.deleteConversation(s.id)),["stop"])},t[18]||(t[18]=[(0,n.Lk)("svg",{class:"delete-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("polyline",{points:"3 6 5 6 21 6"}),(0,n.Lk)("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})],-1)]),8,m)])],10,g)))),128))])),_:1})])]),(0,n.Lk)("main",v,[(0,n.Lk)("div",w,[t[24]||(t[24]=(0,n.Lk)("div",{class:"title"},"Report Collection",-1)),(0,n.Lk)("div",{class:"user-profile",onClick:t[3]||(t[3]=(0,a.D$)(((...e)=>J.handleUserProfileClick&&J.handleUserProfileClick(...e)),["stop"]))},[(0,n.Lk)("div",k,[J.currentUser&&J.currentUser.username?((0,n.uX)(),(0,n.CE)("span",f,(0,i.v_)(J.currentUser.username.charAt(0).toUpperCase()),1)):((0,n.uX)(),(0,n.CE)("svg",y,t[19]||(t[19]=[(0,n.Lk)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"},null,-1),(0,n.Lk)("circle",{cx:"12",cy:"7",r:"4"},null,-1)])))]),r.isUserPopupOpen?((0,n.uX)(),(0,n.CE)("div",S,[(0,n.Lk)("div",C,[t[20]||(t[20]=(0,n.Lk)("div",{class:"user-popup-avatar"},[(0,n.Lk)("svg",{class:"user-popup-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),(0,n.Lk)("circle",{cx:"12",cy:"7",r:"4"})])],-1)),(0,n.Lk)("div",_,[(0,n.Lk)("div",I,(0,i.v_)(J.currentUser?J.currentUser.username:"No Username"),1),(0,n.Lk)("div",b,(0,i.v_)(J.currentUser&&J.currentUser.email||"No Email"),1),(0,n.Lk)("div",L,(0,i.v_)(J.currentUser&&J.currentUser.deptname||"No deptname"),1)])]),(0,n.Lk)("div",A,[t[22]||(t[22]=(0,n.Lk)("a",{href:"https://go/nrdvoc",target:"_blank",rel:"noopener noreferrer",class:"menu-item",style:{"text-decoration":"none",color:"inherit",cursor:"pointer",position:"relative","z-index":"10"},onclick:"event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); window.open(this.href, '_blank', 'noopener'); return false;"},[(0,n.Lk)("svg",{class:"menu-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),(0,n.Lk)("circle",{cx:"12",cy:"7",r:"4"})]),(0,n.eW)(" User VOE ")],-1)),t[23]||(t[23]=(0,n.Lk)("a",{href:"https://confluence.samsungds.net/spaces/DAE/pages/2420017795/%EB%B6%88%EB%B0%B1+%EA%B0%9C%EB%B0%9C+%ED%98%84%ED%99%A9%ED%8C%90",target:"_blank",rel:"noopener noreferrer",class:"menu-item",style:{"text-decoration":"none",color:"inherit",cursor:"pointer",position:"relative","z-index":"10"},onclick:"event.preventDefault(); event.stopPropagation(); event.stopImmediatePropagation(); window.open(this.href, '_blank', 'noopener'); return false;"},[(0,n.Lk)("svg",{class:"menu-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),(0,n.Lk)("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]),(0,n.eW)(" RC Info ")],-1)),(0,n.Lk)("div",{class:"menu-item",onClick:t[2]||(t[2]=(...e)=>J.logout&&J.logout(...e))},t[21]||(t[21]=[(0,n.Lk)("svg",{class:"menu-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),(0,n.Lk)("polyline",{points:"16 17 21 12 16 7"}),(0,n.Lk)("line",{x1:"21",y1:"12",x2:"9",y2:"12"})],-1),(0,n.eW)(" Logout ")]))])])):(0,n.Q3)("",!0)])]),(0,n.bF)(X,null,{default:(0,n.k6)((({Component:e})=>[(0,n.bF)(a.eB,{name:"fade",mode:"out-in"},{default:(0,n.k6)((()=>[((0,n.uX)(),(0,n.Wv)((0,n.$y)(e)))])),_:2},1024)])),_:1})]),r.showApiKeyModal?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"modal-overlay",onClick:t[8]||(t[8]=(0,a.D$)((e=>r.showApiKeyModal=!1),["self"]))},[(0,n.Lk)("div",$,[(0,n.Lk)("div",T,[t[25]||(t[25]=(0,n.Lk)("h3",null,"Set OpenAI API Key",-1)),(0,n.Lk)("button",{class:"close-btn",onClick:t[4]||(t[4]=e=>r.showApiKeyModal=!1)},"×")]),(0,n.Lk)("div",E,[t[28]||(t[28]=(0,n.Lk)("p",{class:"api-key-info"},"Your API key is stored locally in your browser and sent directly to the API. We never store your API key on our servers.",-1)),(0,n.Lk)("div",R,[t[27]||(t[27]=(0,n.Lk)("label",{for:"apiKey"},"OpenAI API Key",-1)),(0,n.bo)((0,n.Lk)("input",{type:"text",id:"apiKey","onUpdate:modelValue":t[5]||(t[5]=e=>r.apiKeyInput=e),placeholder:"sk-...",class:(0,i.C4)({error:e.$store.state.apiKeyError})},null,2),[[a.Jo,r.apiKeyInput]]),e.$store.state.apiKeyError?((0,n.uX)(),(0,n.CE)("p",x,(0,i.v_)(e.$store.state.apiKeyError),1)):(0,n.Q3)("",!0),e.$store.state.apiKeySet&&!e.$store.state.apiKeyError?((0,n.uX)(),(0,n.CE)("p",O,t[26]||(t[26]=[(0,n.Lk)("svg",{class:"check-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("polyline",{points:"20 6 9 17 4 12"})],-1),(0,n.eW)(" API Key is set ")]))):(0,n.Q3)("",!0)]),t[29]||(t[29]=(0,n.Lk)("p",{class:"api-key-help"},[(0,n.eW)(" Don't have an API key? "),(0,n.Lk)("a",{href:"https://platform.openai.com/account/api-keys",target:"_blank"},"Get one from OpenAI")],-1))]),(0,n.Lk)("div",U,[(0,n.Lk)("button",{class:"cancel-btn",onClick:t[6]||(t[6]=e=>r.showApiKeyModal=!1)},"Cancel"),(0,n.Lk)("button",{class:"save-btn",onClick:t[7]||(t[7]=(...e)=>J.saveApiKey&&J.saveApiKey(...e)),disabled:!r.apiKeyInput.trim().startsWith("sk-")}," Save API Key ",8,M)])])])):(0,n.Q3)("",!0),r.showLlamaApiModal?((0,n.uX)(),(0,n.CE)("div",{key:1,class:"modal-overlay",onClick:t[15]||(t[15]=(0,a.D$)((e=>r.showLlamaApiModal=!1),["self"]))},[(0,n.Lk)("div",P,[(0,n.Lk)("div",D,[t[30]||(t[30]=(0,n.Lk)("h3",null,"Set Custom Llama API",-1)),(0,n.Lk)("button",{class:"close-btn",onClick:t[9]||(t[9]=e=>r.showLlamaApiModal=!1)},"×")]),(0,n.Lk)("div",N,[t[34]||(t[34]=(0,n.Lk)("p",{class:"api-key-info"},"Configure your custom Llama API settings. Your API key is stored locally in your browser.",-1)),(0,n.Lk)("div",K,[t[31]||(t[31]=(0,n.Lk)("label",{for:"llamaApiKey"},"Custom API Key",-1)),(0,n.bo)((0,n.Lk)("input",{type:"text",id:"llamaApiKey","onUpdate:modelValue":t[10]||(t[10]=e=>r.llamaApiKeyInput=e),placeholder:""},null,512),[[a.Jo,r.llamaApiKeyInput]])]),(0,n.Lk)("div",F,[t[32]||(t[32]=(0,n.Lk)("label",{for:"llamaApiBase"},"API Base URL (Optional)",-1)),(0,n.bo)((0,n.Lk)("input",{type:"text",id:"llamaApiBase","onUpdate:modelValue":t[11]||(t[11]=e=>r.llamaApiBaseInput=e),placeholder:""},null,512),[[a.Jo,r.llamaApiBaseInput]])]),(0,n.Lk)("div",B,[t[33]||(t[33]=(0,n.Lk)("label",{for:"llamaApiEndpoint"},"API Endpoint (Optional)",-1)),(0,n.bo)((0,n.Lk)("input",{type:"text",id:"llamaApiEndpoint","onUpdate:modelValue":t[12]||(t[12]=e=>r.llamaApiEndpointInput=e),placeholder:""},null,512),[[a.Jo,r.llamaApiEndpointInput]])]),t[35]||(t[35]=(0,n.Lk)("p",{class:"api-key-help"}," If you provide just the API key, the default endpoint will be used. ",-1))]),(0,n.Lk)("div",j,[(0,n.Lk)("button",{class:"cancel-btn",onClick:t[13]||(t[13]=e=>r.showLlamaApiModal=!1)},"Cancel"),(0,n.Lk)("button",{class:"save-btn",onClick:t[14]||(t[14]=(...e)=>J.saveLlamaApiSettings&&J.saveLlamaApiSettings(...e)),disabled:!r.llamaApiKeyInput.trim()}," Save API Settings ",8,Q)])])])):(0,n.Q3)("",!0)],2)}const X={name:"App",data(){return{isDarkMode:!0,isSidebarCollapsed:"true"===localStorage.getItem("sidebarCollapsed")||!1,isUserPopupOpen:!1,showApiKeyModal:!1,showLlamaApiModal:!1,apiKeyInput:"",llamaApiKeyInput:"",llamaApiBaseInput:"",llamaApiEndpointInput:""}},computed:{currentUser(){return this.$store.state.user},isUserAuthenticated(){const e=localStorage.getItem("access_token");return e&&this.$store.state.isAuthenticated}},watch:{currentUser:{handler(){},deep:!0,immediate:!0},isUserAuthenticated:{handler(){},immediate:!0}},methods:{toggleDarkMode(){this.isDarkMode=!this.isDarkMode,localStorage.setItem("darkMode",this.isDarkMode)},toggleSidebar(){this.isSidebarCollapsed=!this.isSidebarCollapsed,localStorage.setItem("sidebarCollapsed",this.isSidebarCollapsed)},async newConversation(){this.$store.commit("setNewConversationTrigger",Date.now())},handleUserProfileClick(e){e&&(e.preventDefault(),e.stopPropagation()),this.isUserPopupOpen=!this.isUserPopupOpen},async logout(){try{this.isUserPopupOpen=!1;const t=localStorage.getItem("access_token");if(t)try{await fetch("http://localhost:8000/api/auth/logout",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}})}catch(e){console.warn("[APP] 백엔드 로그아웃 API 호출 실패 (계속 진행):",e.message)}await this.$store.dispatch("logout"),sessionStorage.removeItem("oauth_processing"),sessionStorage.removeItem("sso_processed"),sessionStorage.removeItem("logout_redirect"),setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(e){try{window.location.href="http://localhost:8000/api/auth/auth_sh"}catch(t){console.error("SSO 리다이렉트 실패:",t)}}}),500)}catch(t){console.error("[APP] 로그아웃 처리 중 오류:",t),this.isUserPopupOpen=!1,this.$store.dispatch("logout"),sessionStorage.removeItem("oauth_processing"),sessionStorage.removeItem("sso_processed"),sessionStorage.removeItem("logout_redirect"),setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(t){try{window.location.href="http://localhost:8000/api/auth/auth_sh"}catch(e){console.error("SSO 리다이렉트 실패:",e)}}}),500)}},async saveApiKey(){if(!this.apiKeyInput.trim().startsWith("sk-"))return void this.$store.commit("setApiKeyError",'Invalid API key format. It should start with "sk-"');const e=await this.$store.dispatch("updateApiKey",this.apiKeyInput.trim());e.success&&(this.showApiKeyModal=!1)},deleteConversation(e){confirm("Are you sure you want to delete this conversation?")&&this.$store.dispatch("deleteConversation",e)},async validateAuthToken(){try{const t=localStorage.getItem("access_token");if(!t)return void this.$store.dispatch("logout");const s=await fetch("http://localhost:8000/api/auth/me",{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});if(s.ok)this._conversationsFetched||(this._conversationsFetched=!0,this.$store.dispatch("fetchConversations"));else{try{await s.text()}catch(e){}401===s.status?setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(e){window.location.href="http://localhost:8000/api/auth/auth_sh"}}),500):this.$store.dispatch("logout")}}catch(t){if(console.error("토큰 검증 중 오류:",t),"TypeError"===t.name&&t.message.includes("fetch"))return void console.error("[APP] 네트워크 오류 - 백엔드 서버 연결 실패");this.$store.dispatch("logout")}},async selectConversation(e){try{console.log("🔄 대화 선택 시작:",e.id);const t=await fetch(`http://localhost:8000/api/conversations/${e.id}/messages`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},credentials:"include"});if(t.ok){const s=await t.json(),a={...e,messages:s.messages||[]};this.$store.commit("setCurrentConversation",a),this.$store.commit("setShouldScrollToBottom",!0),this.$store.commit("setConversationRestored",!0),console.log("✅ 대화 선택 완료:",{conversationId:e.id,messageCount:s.messages?.length||0})}else{const s=await t.text();console.error("❌ 대화 메시지 가져오기 실패:",{status:t.status,statusText:t.statusText,error:s}),this.$store.commit("setCurrentConversation",e)}}catch(t){console.error("❌ 대화 선택 오류:",t),this.$store.commit("setCurrentConversation",e)}},async saveLlamaApiSettings(){try{const e=await this.$store.dispatch("updateLlamaApiSettings",{apiKey:this.llamaApiKeyInput,apiBase:this.llamaApiBaseInput||void 0,apiEndpoint:this.llamaApiEndpointInput||void 0});e.success&&(this.showLlamaApiModal=!1)}catch(e){}},adjustTextareaHeight(){const e=this.$refs.inputField;if(!e)return;e.style.height="auto";const t=Math.min(e.scrollHeight,150);e.style.height=t+"px"},getConversationTitle(e){return e&&e.title&&"New Conversation"!==e.title?e.title:"New Conversation"},getConversationIcon(e){const t={image:"🖼️",code:"💻",document:"📄",math:"🧮",general:"💬",graph:"📊",analysis:"📈",data:"🔢",dashboard:"📱",ai:"🤖",search:"🔍",translation:"🔤",audio:"🎵",video:"🎬",design:"🎨",map:"🗺️",science:"🔬",finance:"💰",health:"⚕️",news:"📰",weather:"☁️",calendar:"📅",task:"✅"};return t[e]||"💬"},formatDate(e){if(!e)return"";const t=new Date(e),s=new Date;return t.toDateString()===s.toDateString()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})},closeDropdowns(e){e.target.closest(".user-profile")||(this.isUserPopupOpen=!1)},enableCopying(){const e=e=>(e.stopPropagation(),!0);document.addEventListener("selectstart",e,{capture:!0,passive:!1}),document.addEventListener("contextmenu",e,{capture:!0,passive:!1}),document.addEventListener("copy",e,{capture:!0,passive:!1}),document.addEventListener("mousedown",e,{capture:!0,passive:!1}),document.addEventListener("mouseup",e,{capture:!0,passive:!1}),document.addEventListener("mousemove",e,{capture:!0,passive:!1}),document.addEventListener("keydown",(e=>(!e.ctrlKey&&!e.metaKey||"c"!==e.key&&"C"!==e.key&&"a"!==e.key&&"A"!==e.key&&"v"!==e.key&&"V"!==e.key||e.stopPropagation(),!0)),{capture:!0,passive:!1}),document.addEventListener("dragstart",e,{capture:!0,passive:!1}),document.body.classList.add("text-selection-enabled")},handleSSOCallback(){const e=new URLSearchParams(window.location.search),t=e.get("token"),s=e.get("username"),a=e.get("error");if(a){console.error("SSO Error:",a);const t=e.get("details")||"";t&&console.error("SSO Error Details:",t);const s=new URL(window.location);return s.search="",window.history.replaceState({},document.title,s),sessionStorage.removeItem("oauth_processing"),!1}if(t&&s){const a=e.get("mail")||"",o=e.get("loginid")||"",r=e.get("username")||"",n=e.get("deptname")||"";this.$store.commit("setAuth",{token:t,user:{username:s,mail:a,loginid:r,id:o,deptname:n}}),this.$store.commit("setLoginNewConversation",!0),setTimeout((()=>{this.$store.state.user&&this.$store.state.user.username||this.$store.dispatch("fetchUserInfo")}),500);const i=new URL(window.location);return i.search="",window.history.replaceState({},document.title,i),this.$store.dispatch("fetchConversations"),"/"!==this.$router.currentRoute.value.path&&this.$router.push("/"),sessionStorage.setItem("sso_processed","true"),sessionStorage.removeItem("oauth_processing"),!0}const o=e.get("code"),r=e.get("state");return!(!o||!r)&&("true"===sessionStorage.getItem("oauth_processing")||(sessionStorage.setItem("oauth_processing","true"),window.location.href=`http://localhost:8000/api/auth/acs?code=${o}&state=${r}`),!0)},processOAuthFromHash(e){const t=new URLSearchParams(e.substring(1)),s=t.get("id_token"),a=t.get("state");if(!s||!a)return;const o=`id_token=${encodeURIComponent(s)}&state=${encodeURIComponent(a)}`;fetch("http://localhost:8000/api/auth/acs",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o,credentials:"include"}).then((e=>{if(e.ok)return e.text();throw new Error(`HTTP error! status: ${e.status}`)})).then((e=>{try{const t=JSON.parse(e);if(t.success&&t.user){this.$store.commit("setAuth",{token:t.token||s,user:t.user}),this.$store.commit("setLoginNewConversation",!0);const e=new URL(window.location);e.hash="",window.history.replaceState({},document.title,e),this.$store.dispatch("fetchConversations"),sessionStorage.setItem("sso_processed","true"),sessionStorage.removeItem("oauth_processing"),this.$forceUpdate()}else sessionStorage.removeItem("oauth_processing")}catch(t){sessionStorage.removeItem("oauth_processing")}})).catch((()=>{sessionStorage.removeItem("oauth_processing")}))},processOAuthFromQuery(e){const t=e.get("code"),s=e.get("id_token"),a=e.get("state"),o=e.get("error");if(o){const e=new URL(window.location);return e.search="",window.history.replaceState({},document.title,e),sessionStorage.removeItem("oauth_processing"),!1}if(t&&s){const e=`code=${encodeURIComponent(t)}&id_token=${encodeURIComponent(s)}&state=${encodeURIComponent(a)}`;return fetch("http://localhost:8000/api/auth/acs",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e,credentials:"include"}).then((e=>{if(e.ok)return e.text();throw new Error(`HTTP error! status: ${e.status}`)})).then((e=>{try{const t=JSON.parse(e);if(t.success&&t.user){this.$store.commit("setAuth",{token:t.token||s,user:t.user}),this.$store.commit("setLoginNewConversation",!0);const e=new URL(window.location);return e.search="",window.history.replaceState({},document.title,e),this.$store.dispatch("fetchConversations"),sessionStorage.setItem("sso_processed","true"),sessionStorage.removeItem("oauth_processing"),this.$forceUpdate(),!0}return sessionStorage.removeItem("oauth_processing"),!1}catch(t){return sessionStorage.removeItem("oauth_processing"),!1}})).catch((()=>(sessionStorage.removeItem("oauth_processing"),!1))),!0}return!1},checkAuthCookies(){function e(e){const t=`; ${document.cookie}`,s=t.split(`; ${e}=`);return 2===s.length?s.pop().split(";").shift():null}const t=e("access_token"),s=e("user_info"),a=e("sso_processed");if(t&&s)try{const e=decodeURIComponent(s),o=JSON.parse(e);return localStorage.setItem("access_token",t),localStorage.setItem("user_info",JSON.stringify(o)),a&&sessionStorage.setItem("sso_processed",a),this.$store.commit("setAuth",{token:t,user:o}),this.$store.commit("setLoginNewConversation",!0),this.$store.dispatch("fetchConversations"),document.cookie="access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=report-collection;",document.cookie="user_info=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; report-collection;",document.cookie="sso_processed=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; report-collection;",!0}catch(o){return console.error("[APP] 쿠키 파싱 실패:",o),!1}return!1}},async created(){if("true"===sessionStorage.getItem("oauth_processing"))return;if("true"===sessionStorage.getItem("sso_processed"))return;const e=window.location.hash,t=new URLSearchParams(window.location.search),s=e&&e.includes("id_token"),a=t.get("code")||t.get("id_token")||t.get("error");if(s||a)return void sessionStorage.setItem("oauth_processing","true");const o=this.checkAuthCookies();if(o)return;if(e&&e.includes("id_token"))return void this.processOAuthFromHash(e);if(a)return void this.processOAuthFromQuery(t);const r=this.handleSSOCallback();if(r)return;const n=localStorage.getItem("access_token"),i=localStorage.getItem("user_info");if(n&&i)try{const e=JSON.parse(i);this.$store.commit("setAuth",{token:n,user:e});const t=await fetch("http://localhost:8000/api/auth/me",{headers:{Authorization:`Bearer ${n}`}});if(t.ok)return void(this._conversationsFetched||(this._conversationsFetched=!0,this.$store.dispatch("fetchConversations")));setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(e){window.location.href="http://localhost:8000/api/auth/auth_sh"}}),500)}catch(g){console.error("[APP] 인증 정보 복원 실패:",g),this.$store.dispatch("logout")}const l="true"===sessionStorage.getItem("logout_redirect");if(l)return void sessionStorage.removeItem("logout_redirect");const c="true"===sessionStorage.getItem("sso_processed"),u="true"===sessionStorage.getItem("oauth_processing");if(!c&&!u){const e=localStorage.getItem("access_token")&&localStorage.getItem("user_info");if(this.$store.state.isAuthenticated||e){if(e&&!this.$store.state.isAuthenticated)try{const e=JSON.parse(localStorage.getItem("user_info"));this.$store.commit("setAuth",{token:localStorage.getItem("access_token"),user:e})}catch(g){console.error("[APP] Store 복원 실패:",g)}}else setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(g){try{window.location.href="http://localhost:8000/api/auth/auth_sh"}catch(e){console.error("SSO 리다이렉트 실패:",e)}}}),1e3)}},mounted(){this.$refs.inputField&&(this.$refs.inputField.focus(),this.adjustTextareaHeight()),this.apiKeyInput=this.$store.state.apiKey||"",this.llamaApiKeyInput=this.$store.state.llamaApiKey||"",this.llamaApiBaseInput=this.$store.state.llamaApiBase||"",this.llamaApiEndpointInput=this.$store.state.llamaApiEndpoint||"",null===localStorage.getItem("darkMode")&&(this.isDarkMode=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,localStorage.setItem("darkMode",this.isDarkMode));const e=localStorage.getItem("access_token"),t=localStorage.getItem("user_info");if(e&&t)try{const s=JSON.parse(t);this.$store.state.isAuthenticated||(this.$store.commit("setAuth",{token:e,user:s}),this._conversationsFetched||(this._conversationsFetched=!0,this.$store.dispatch("fetchConversations").then((()=>{})).catch((e=>{console.error("[APP] mounted에서 대화 목록 가져오기 실패:",e)})))),this.validateAuthToken()}catch(s){console.error("Stored user info parsing error:",s),localStorage.removeItem("access_token"),localStorage.removeItem("user_info")}document.addEventListener("click",this.closeDropdowns),this.enableCopying()},beforeUnmount(){document.removeEventListener("click",this.closeDropdowns)}};var H=s(241);const G=(0,H.A)(X,[["render",J]]),q=G,V={class:"home"},z={class:"chat-container"},W={class:"chat-messages",ref:"chatMessages"},Y={key:0,class:"empty-state"};function Z(e,t,s,a,o,r){const i=(0,n.g2)("LanggraphContainer"),l=(0,n.g2)("MessageList"),c=(0,n.g2)("ChatInput"),u=(0,n.g2)("SearchResultPopup");return(0,n.uX)(),(0,n.CE)("div",V,[(0,n.Lk)("div",z,[(0,n.Lk)("div",W,[(0,n.bF)(i,{"show-langgraph":a.langgraph.showLanggraph.value,"current-step":a.langgraph.currentStep.value,"original-input":a.langgraph.originalInput.value,"augmented-keywords":a.langgraph.augmentedKeywords.value,"is-searching":a.langgraph.isSearching.value,"search-results":a.langgraph.searchResults.value,"searched-documents":a.langgraph.searchedDocuments.value,"has-search-completed":a.langgraph.hasSearchCompleted.value,"is-generating-answer":a.langgraph.isGeneratingAnswer.value,"final-answer":a.langgraph.finalAnswer.value,"streaming-answer":a.langgraph.streamingAnswer.value,"is-streaming-answer":a.langgraph.isStreamingAnswer.value,"analysis-image-url":a.langgraph.analysisImageUrl.value,"image-load-failed":a.langgraph.imageLoadFailed.value,"failed-image-url":a.langgraph.failedImageUrl.value,"last-image-url":a.langgraph.lastImageUrl.value,onOpenSearchResult:r.openSearchResultPopup,onOpenImageInNewTab:r.openImageInNewTab},null,8,["show-langgraph","current-step","original-input","augmented-keywords","is-searching","search-results","searched-documents","has-search-completed","is-generating-answer","final-answer","streaming-answer","is-streaming-answer","analysis-image-url","image-load-failed","failed-image-url","last-image-url","onOpenSearchResult","onOpenImageInNewTab"]),e.$store.state.currentConversation?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",Y,t[0]||(t[0]=[(0,n.Fv)('<div class="empty-illustration"><svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line></svg></div><p>Start a new conversation</p>',2)]))),(0,n.bF)(l,{"current-messages":r.currentMessages,"is-streaming":e.$store.state.isStreaming,"streaming-message":e.$store.state.streamingMessage,"streaming-visible":a.sse.streamingVisible.value,"last-message-height":a.scroll.lastMessageHeight.value,onSubmitFeedback:r.submitFeedback},null,8,["current-messages","is-streaming","streaming-message","streaming-visible","last-message-height","onSubmitFeedback"])],512),(0,n.bF)(c,{"is-loading":a.messages.isLoading.value,"is-streaming":e.$store.state.isStreaming,onSendMessage:r.sendChatMessage,onInputChange:r.handleInputChange,ref:"chatInput"},null,8,["is-loading","is-streaming","onSendMessage","onInputChange"]),(0,n.bF)(u,{show:o.showSearchResultPopup,result:o.selectedSearchResult,onClose:r.closeSearchResultPopup},null,8,["show","result","onClose"])])])}const ee={class:"popup-header"},te={key:0,class:"popup-content"},se={class:"popup-section"},ae={class:"popup-section"},oe={class:"popup-section"},re={class:"popup-section"},ne={class:"full-text"},ie={key:0,class:"popup-section"},le={class:"popup-image-container"},ce=["src","alt"],ue={key:0,class:"image-loading"},ge={key:1,class:"image-error"};function de(e,t,s,o,r,l){return s.show?((0,n.uX)(),(0,n.CE)("div",{key:0,class:"search-result-popup-overlay",onClick:t[4]||(t[4]=(...e)=>l.closePopup&&l.closePopup(...e))},[(0,n.Lk)("div",{class:"search-result-popup",onClick:t[3]||(t[3]=(0,a.D$)((()=>{}),["stop"]))},[(0,n.Lk)("div",ee,[t[5]||(t[5]=(0,n.Lk)("h3",null,"검색 결과 상세",-1)),(0,n.Lk)("button",{class:"close-btn",onClick:t[0]||(t[0]=(...e)=>l.closePopup&&l.closePopup(...e))},"×")]),s.result?((0,n.uX)(),(0,n.CE)("div",te,[(0,n.Lk)("div",se,[t[6]||(t[6]=(0,n.Lk)("h4",null,"📄 문서 제목",-1)),(0,n.Lk)("p",null,(0,i.v_)(s.result.res_payload?.document_name||s.result.title||"제목 없음"),1)]),(0,n.Lk)("div",ae,[t[7]||(t[7]=(0,n.Lk)("h4",null,"📊 유사도 점수",-1)),(0,n.Lk)("p",null,(0,i.v_)((s.result.res_score||s.result.score||0).toFixed(4)),1)]),(0,n.Lk)("div",oe,[t[8]||(t[8]=(0,n.Lk)("h4",null,"📝 요약",-1)),(0,n.Lk)("p",null,(0,i.v_)(s.result.res_payload?.vector?.summary_result||s.result.summary||"요약 없음"),1)]),(0,n.Lk)("div",re,[t[9]||(t[9]=(0,n.Lk)("h4",null,"📖 전체 내용",-1)),(0,n.Lk)("p",ne,(0,i.v_)(s.result.res_payload?.vector?.text||s.result.text||"내용 없음"),1)]),l.getImageUrls(s.result.res_payload?.vector?.image_url||s.result.res_payload?.image_url||s.result.image_url||s.result.analysis_image_url).length>0?((0,n.uX)(),(0,n.CE)("div",ie,[t[12]||(t[12]=(0,n.Lk)("h4",null,"🖼️ 관련 이미지",-1)),(0,n.Lk)("div",le,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(l.getImageUrls(s.result.res_payload?.vector?.image_url||s.result.res_payload?.image_url||s.result.image_url||s.result.analysis_image_url),((e,a)=>((0,n.uX)(),(0,n.CE)("div",{key:a,class:"image-item"},[(0,n.Lk)("img",{src:l.getFullImageUrl(e),alt:`${s.result.res_payload?.document_name||s.result.title} - 이미지 ${a+1}`,class:"popup-image",onError:t[1]||(t[1]=(...e)=>l.handleImageError&&l.handleImageError(...e)),onLoad:t[2]||(t[2]=(...e)=>l.handleImageLoad&&l.handleImageLoad(...e))},null,40,ce)])))),128)),r.imageLoading?((0,n.uX)(),(0,n.CE)("div",ue,t[10]||(t[10]=[(0,n.Lk)("div",{class:"spinner"},null,-1),(0,n.Lk)("span",null,"이미지 로딩 중...",-1)]))):(0,n.Q3)("",!0),r.imageError?((0,n.uX)(),(0,n.CE)("div",ge,t[11]||(t[11]=[(0,n.Lk)("span",null,"🖼️ 이미지를 불러올 수 없습니다",-1)]))):(0,n.Q3)("",!0)])])):(0,n.Q3)("",!0)])):(0,n.Q3)("",!0)])])):(0,n.Q3)("",!0)}const he={name:"SearchResultPopup",props:{show:{type:Boolean,default:!1},result:{type:Object,default:null}},data(){return{imageLoading:!1,imageError:!1}},methods:{closePopup(){this.$emit("close")},getImageUrls(e){if(console.log("🖼️ 팝업 이미지 URL 원본 데이터:",{payloadVector:this.result?.res_payload?.vector?.image_url,payloadRoot:this.result?.res_payload?.image_url,direct:this.result?.image_url,analysis:this.result?.analysis_image_url,incoming:e}),!e)return[];if(Array.isArray(e)){const t=e.map((e=>{if(console.log("🔍 처리 중인 URL:",e),"string"===typeof e&&e.includes(":")){const t=e.split(":").slice(1).join(":");return console.log("✅ 추출된 URL:",t),t}return e})).filter((e=>e));return console.log("🎯 최종 처리된 URL 배열:",t),t}if("string"===typeof e){if(e.includes(":")){const t=e.split(":").slice(1).join(":");return console.log("✅ 문자열에서 추출된 URL:",t),t?[t]:[]}return[e]}return[]},getFullImageUrl(e){if(!e)return"";console.log("🔗 변환 전 URL:",e);const t=e.replace(/^\/appdata\/RC\/images\//,"https://10.172.107.182/imageview/");return t},handleImageError(e){this.imageLoading=!1,this.imageError=!0,console.error("이미지 로딩 실패:",e.target.src)},handleImageLoad(){this.imageLoading=!1,this.imageError=!1}},watch:{show(e){e&&(this.result?.res_payload?.vector?.image_url||this.result?.res_payload?.image_url||this.result?.image_url||this.result?.analysis_image_url)&&(this.imageLoading=!0,this.imageError=!1)}}},pe=(0,H.A)(he,[["render",de],["__scopeId","data-v-eeeb3cb2"]]),me=pe,ve={key:0,class:"langgraph-container"},we={class:"step-header"},ke={key:0,class:"step-status"},fe={class:"step-content"},ye={class:"original-input"},Se={key:0},Ce={key:1,class:"placeholder-text"},_e={class:"keywords-list"},Ie={class:"keyword-category"},be={key:0,class:"no-keywords"},Le={class:"step-header"},Ae={key:0,class:"step-status"},$e={class:"step-content"},Te={class:"search-status"},Ee={key:0,class:"searching-indicator"},Re={key:1,class:"search-results"},xe={class:"results-list"},Oe={class:"result-header"},Ue={class:"result-number"},Me={class:"result-content"},Pe={class:"result-title"},De=["onClick"],Ne={class:"result-header"},Ke={class:"result-number"},Fe={class:"result-score"},Be={class:"result-content"},je={class:"result-title"},Qe={class:"result-summary"},Je={class:"result-text"},Xe={key:0,class:"result-image-indicator"},He={key:2,class:"no-search-results"},Ge={class:"step-header"},qe={key:0,class:"step-status"},Ve={class:"step-content"},ze={class:"answer-section"},We={key:0,class:"generating-indicator"},Ye={key:1,class:"final-answer"},Ze=["innerHTML"],et={key:0,class:"streaming-indicator"},tt={class:"step-header"},st={key:0,class:"step-status"},at={class:"step-content"},ot={class:"image-section"},rt={key:0,class:"analysis-image"},nt={class:"image-container"},it={key:0,class:"image-error-display"},lt={class:"error-message"},ct={class:"error-url"},ut={class:"url-text"},gt={key:1,class:"image-wrapper"},dt=["src"],ht={key:1,class:"no-image-results"},pt={class:"langgraph-progress"},mt={class:"progress-bar"},vt={class:"progress-text"};function wt(e,t,s,a,o,r){return s.showLanggraph?((0,n.uX)(),(0,n.CE)("div",ve,[t[27]||(t[27]=(0,n.Lk)("div",{class:"langgraph-header"},[(0,n.Lk)("h2",null,"🔬 AI 분석 - 랭그래프")],-1)),(0,n.Lk)("div",{class:(0,i.C4)(["langgraph-step",{active:s.currentStep>=1}])},[(0,n.Lk)("div",we,[t[2]||(t[2]=(0,n.Lk)("div",{class:"step-number"},"1",-1)),t[3]||(t[3]=(0,n.Lk)("h3",null,"키워드 증강",-1)),s.currentStep>=1?((0,n.uX)(),(0,n.CE)("div",ke,t[1]||(t[1]=[(0,n.Lk)("span",{class:"status-icon"},"✓",-1)]))):(0,n.Q3)("",!0)]),(0,n.Lk)("div",fe,[((0,n.uX)(),(0,n.CE)("div",{class:"input-section",key:"input-"+(s.originalInput||"empty")},[t[4]||(t[4]=(0,n.Lk)("label",{class:"section-label"},"입력된 내용:",-1)),(0,n.Lk)("div",ye,[s.originalInput?((0,n.uX)(),(0,n.CE)("span",Se,(0,i.v_)(s.originalInput),1)):((0,n.uX)(),(0,n.CE)("span",Ce,"입력된 내용이 없습니다."))])])),((0,n.uX)(),(0,n.CE)("div",{class:"augmented-keywords",key:"keywords-"+(s.augmentedKeywords.length||0)},[t[6]||(t[6]=(0,n.Lk)("label",{class:"section-label"},"증강된 키워드:",-1)),(0,n.Lk)("div",_e,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(s.augmentedKeywords,(e=>((0,n.uX)(),(0,n.CE)("span",{key:e.id,class:(0,i.C4)(["keyword-tag",e.category])},[(0,n.eW)((0,i.v_)(e.text)+" ",1),(0,n.Lk)("span",Ie,(0,i.v_)(e.category),1)],2)))),128)),s.augmentedKeywords&&0!==s.augmentedKeywords.length?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",be,t[5]||(t[5]=[(0,n.Lk)("div",{class:"loading-container"},[(0,n.Lk)("div",{class:"spinner"}),(0,n.Lk)("span",null,"키워드를 증강 중입니다")],-1)])))])]))])],2),(0,n.Lk)("div",{class:(0,i.C4)(["langgraph-step",{active:s.currentStep>=2}])},[(0,n.Lk)("div",Le,[t[8]||(t[8]=(0,n.Lk)("div",{class:"step-number"},"2",-1)),t[9]||(t[9]=(0,n.Lk)("h3",null,"증강된 키워드로 DB 검색",-1)),s.currentStep>=2?((0,n.uX)(),(0,n.CE)("div",Ae,t[7]||(t[7]=[(0,n.Lk)("span",{class:"status-icon"},"✓",-1)]))):(0,n.Q3)("",!0)]),(0,n.Lk)("div",$e,[(0,n.Lk)("div",Te,[s.currentStep>=2&&s.isSearching?((0,n.uX)(),(0,n.CE)("div",Ee,t[10]||(t[10]=[(0,n.Lk)("div",{class:"spinner"},null,-1),(0,n.Lk)("span",null,"데이터베이스 검색 중...",-1)]))):s.currentStep>=2&&("number"===typeof s.searchResults&&s.searchResults>0||Array.isArray(s.searchResults)&&s.searchResults.length>0)?((0,n.uX)(),(0,n.CE)("div",Re,[(0,n.Lk)("label",null,"검색 결과 ("+(0,i.v_)("number"===typeof s.searchResults?s.searchResults:s.searchResults.length)+"건):",1),(0,n.Lk)("div",xe,["number"===typeof s.searchResults&&s.searchedDocuments&&s.searchedDocuments.length>0?((0,n.uX)(!0),(0,n.CE)(n.FK,{key:0},(0,n.pI)(s.searchedDocuments.slice(0,5),((e,t)=>((0,n.uX)(),(0,n.CE)("div",{key:t,class:"result-item simple"},[(0,n.Lk)("div",Oe,[(0,n.Lk)("span",Ue,"#"+(0,i.v_)(t+1),1)]),(0,n.Lk)("div",Me,[(0,n.Lk)("div",Pe,(0,i.v_)(e),1)])])))),128)):Array.isArray(s.searchResults)?((0,n.uX)(!0),(0,n.CE)(n.FK,{key:1},(0,n.pI)(s.searchResults.slice(0,5),((t,s)=>((0,n.uX)(),(0,n.CE)("div",{key:s,class:"result-item detailed clickable",onClick:s=>e.$emit("openSearchResult",t)},[(0,n.Lk)("div",Ne,[(0,n.Lk)("span",Ke,"#"+(0,i.v_)(s+1),1),(0,n.Lk)("span",Fe,"유사도: "+(0,i.v_)((t.res_score||t.score||0).toFixed(4)),1)]),(0,n.Lk)("div",Be,[(0,n.Lk)("div",je,(0,i.v_)(t.res_payload?.document_name||t.title||"제목 없음"),1),(0,n.Lk)("div",Qe,(0,i.v_)(t.res_payload?.vector?.summary_result||t.summary||"요약 없음"),1),(0,n.Lk)("div",Je,(0,i.v_)(t.res_payload?.vector?.text||t.text||"내용 없음"),1),t.res_payload?.vector?.image_url||t.res_payload?.image_url||t.image_url||t.analysis_image_url?((0,n.uX)(),(0,n.CE)("div",Xe," 🖼️ 이미지 포함 (클릭하여 보기) ")):(0,n.Q3)("",!0)])],8,De)))),128)):(0,n.Q3)("",!0)])])):s.currentStep>=2&&s.hasSearchCompleted&&!s.isSearching&&(0===s.searchResults||Array.isArray(s.searchResults)&&0===s.searchResults.length)?((0,n.uX)(),(0,n.CE)("div",He,t[11]||(t[11]=[(0,n.Lk)("div",{class:"no-results-icon"},"🔍",-1),(0,n.Lk)("div",{class:"no-results-message"},[(0,n.Lk)("strong",null,"검색 결과가 없습니다"),(0,n.Lk)("p",null,"데이터베이스에서 관련 정보를 찾을 수 없습니다."),(0,n.Lk)("div",{class:"improvement-suggestions"},[(0,n.Lk)("strong",null,"개선 제안:"),(0,n.Lk)("ul",null,[(0,n.Lk)("li",null,"질문을 더 구체적으로 작성해주세요"),(0,n.Lk)("li",null,"관련 키워드를 추가해주세요"),(0,n.Lk)("li",null,"데이터베이스에 관련 문서가 있는지 확인해주세요")])])],-1)]))):(0,n.Q3)("",!0)])])],2),(0,n.Lk)("div",{class:(0,i.C4)(["langgraph-step",{active:s.currentStep>=3}])},[(0,n.Lk)("div",Ge,[t[13]||(t[13]=(0,n.Lk)("div",{class:"step-number"},"3",-1)),t[14]||(t[14]=(0,n.Lk)("h3",null,"검색된 내용 기반 답변",-1)),s.currentStep>=3?((0,n.uX)(),(0,n.CE)("div",qe,t[12]||(t[12]=[(0,n.Lk)("span",{class:"status-icon"},"✓",-1)]))):(0,n.Q3)("",!0)]),(0,n.Lk)("div",Ve,[(0,n.Lk)("div",ze,[s.currentStep>=3&&s.isGeneratingAnswer?((0,n.uX)(),(0,n.CE)("div",We,t[15]||(t[15]=[(0,n.Lk)("div",{class:"spinner"},null,-1),(0,n.Lk)("span",null,"🤖 AI가 검색 결과를 분석하여 답변을 생성하고 있습니다...",-1)]))):s.currentStep>=3&&(s.finalAnswer||s.streamingAnswer)?((0,n.uX)(),(0,n.CE)("div",Ye,[t[17]||(t[17]=(0,n.Lk)("label",null,"최종 답변:",-1)),(0,n.Lk)("div",{class:"answer-content",innerHTML:r.formatAnswer(s.streamingAnswer||s.finalAnswer)},null,8,Ze),s.isStreamingAnswer?((0,n.uX)(),(0,n.CE)("div",et,t[16]||(t[16]=[(0,n.Lk)("div",{class:"typing-dots"},[(0,n.Lk)("span"),(0,n.Lk)("span"),(0,n.Lk)("span")],-1),(0,n.Lk)("span",null,"답변 생성 중...",-1)]))):(0,n.Q3)("",!0)])):(0,n.Q3)("",!0)])])],2),(0,n.Lk)("div",{class:(0,i.C4)(["langgraph-step",{active:s.currentStep>=4}])},[(0,n.Lk)("div",tt,[t[19]||(t[19]=(0,n.Lk)("div",{class:"step-number"},"4",-1)),t[20]||(t[20]=(0,n.Lk)("h3",null,"분석 결과 이미지",-1)),s.currentStep>=4?((0,n.uX)(),(0,n.CE)("div",st,t[18]||(t[18]=[(0,n.Lk)("span",{class:"status-icon"},"✓",-1)]))):(0,n.Q3)("",!0)]),(0,n.Lk)("div",at,[(0,n.Lk)("div",ot,[s.currentStep>=4&&s.analysisImageUrl?((0,n.uX)(),(0,n.CE)("div",rt,[t[25]||(t[25]=(0,n.Lk)("label",null,"분석 결과:",-1)),(0,n.Lk)("div",nt,[s.imageLoadFailed?((0,n.uX)(),(0,n.CE)("div",it,[t[24]||(t[24]=(0,n.Lk)("div",{class:"error-icon"},"⚠️",-1)),(0,n.Lk)("div",lt,[t[22]||(t[22]=(0,n.Lk)("strong",null,"이미지를 불러올 수 없습니다",-1)),t[23]||(t[23]=(0,n.Lk)("p",null,"네트워크 연결을 확인하거나 서버 상태를 점검해주세요.",-1)),(0,n.Lk)("div",ct,[t[21]||(t[21]=(0,n.Lk)("label",null,"이미지 URL:",-1)),(0,n.Lk)("code",ut,(0,i.v_)(s.failedImageUrl),1)])])])):((0,n.uX)(),(0,n.CE)("div",gt,[(0,n.Lk)("img",{src:s.analysisImageUrl,alt:"분석 이미지",class:"analysis-image",onClick:t[0]||(t[0]=t=>e.$emit("openImageInNewTab",s.analysisImageUrl))},null,8,dt)]))])])):s.currentStep>=4&&!s.analysisImageUrl?((0,n.uX)(),(0,n.CE)("div",ht,t[26]||(t[26]=[(0,n.Lk)("div",{class:"no-image-icon"},"🖼️",-1),(0,n.Lk)("div",{class:"no-image-message"},[(0,n.Lk)("strong",null,"이미지 URL이 설정되지 않았습니다"),(0,n.Lk)("p",null,"RAG 검색 결과를 기반으로 한 이미지 URL이 생성되지 않았습니다.")],-1)]))):(0,n.Q3)("",!0)])])],2),(0,n.Lk)("div",pt,[(0,n.Lk)("div",mt,[(0,n.Lk)("div",{class:"progress-fill",style:(0,i.Tr)({width:r.progressPercentage+"%"})},null,4)]),(0,n.Lk)("div",vt,(0,i.v_)(s.currentStep)+"/4 단계 완료",1)])])):(0,n.Q3)("",!0)}const kt={name:"LanggraphContainer",props:{showLanggraph:{type:Boolean,default:!1},currentStep:{type:Number,default:0},originalInput:{type:String,default:""},augmentedKeywords:{type:Array,default:()=>[]},isSearching:{type:Boolean,default:!1},searchResults:{type:[Array,Number],default:()=>[]},searchedDocuments:{type:Array,default:()=>[]},hasSearchCompleted:{type:Boolean,default:!1},isGeneratingAnswer:{type:Boolean,default:!1},finalAnswer:{type:String,default:""},streamingAnswer:{type:String,default:""},isStreamingAnswer:{type:Boolean,default:!1},analysisImageUrl:{type:String,default:""},imageLoadFailed:{type:Boolean,default:!1},failedImageUrl:{type:String,default:""},lastImageUrl:{type:String,default:""}},emits:["openSearchResult","openImageInNewTab"],computed:{progressPercentage(){return this.currentStep/4*100}},watch:{showLanggraph(e,t){console.log("🔍 [DEBUG] LanggraphContainer showLanggraph 변화:",{oldVal:t,newVal:e})},currentStep(e,t){console.log("🔍 [DEBUG] LanggraphContainer currentStep 변화:",{oldVal:t,newVal:e})}},methods:{formatAnswer(e){if(!e)return"";let t=e;t=t.replace(/^### (.*$)/gm,'<h3 class="markdown-h3">$1</h3>'),t=t.replace(/^## (.*$)/gm,'<h2 class="markdown-h2">$1</h2>'),t=t.replace(/^# (.*$)/gm,'<h1 class="markdown-h1">$1</h1>'),t=t.replace(/\*\*(.*?)\*\*/g,'<strong class="markdown-bold">$1</strong>');const s=/(\|[^\n]+\|\n)+/g;return t=t.replace(s,(e=>{const t=e.trim().split("\n");let s='<table class="markdown-table">';return t.forEach(((e,t)=>{if(e.trim()&&!e.match(/^\|[-\s|]+\|$/)){const a=e.split("|").map((e=>e.trim())).filter((e=>e));a.length>0&&(s+="<tr>",a.forEach((e=>{s+=0===t?`<th class="markdown-th">${e}</th>`:`<td class="markdown-td">${e}</td>`})),s+="</tr>")}})),s+="</table>",s})),t=t.replace(/^- (.*$)/gm,'<li class="markdown-li">$1</li>'),t=t.replace(/(<li class="markdown-li">.*<\/li>)/s,'<ul class="markdown-ul">$1</ul>'),t=t.replace(/^\d+\. (.*$)/gm,'<li class="markdown-oli">$1</li>'),t=t.replace(/(<li class="markdown-oli">.*<\/li>)/s,'<ol class="markdown-ol">$1</ol>'),t=t.replace(/```([\s\S]*?)```/g,'<pre class="markdown-code"><code>$1</code></pre>'),t=t.replace(/`([^`]+)`/g,'<code class="markdown-inline-code">$1</code>'),t=t.replace(/\n\n/g,'</p><p class="markdown-p">'),t=t.replace(/\n/g,"<br>"),t=(t.includes('<p class="markdown-p">'),`<p class="markdown-p">${t}</p>`),t}}},ft=(0,H.A)(kt,[["render",wt],["__scopeId","data-v-7e44560c"]]),yt=ft,St={class:"messages-container",style:{transform:"translateZ(0)"}},Ct={class:"messages-wrapper"},_t={key:0,class:"empty-state"},It={key:0,class:"message user"},bt={class:"message-content"},Lt={class:"message-text"},At={key:1,class:"message assistant"},$t={class:"message-content"},Tt=["innerHTML"],Et={class:"message-actions"},Rt=["onClick","disabled","title"],xt=["onClick","disabled","title"],Ot={class:"message-content",ref:"streamingContent"},Ut={class:"message-text",ref:"streamingText"};function Mt(e,t,s,a,o,r){return(0,n.uX)(),(0,n.CE)("div",St,[(0,n.Lk)("div",Ct,[s.currentMessages&&0!==s.currentMessages.length?(0,n.Q3)("",!0):((0,n.uX)(),(0,n.CE)("div",_t,t[0]||(t[0]=[(0,n.Fv)('<div class="empty-illustration" data-v-4a18db6b><svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-v-4a18db6b><rect x="3" y="3" width="18" height="18" rx="2" ry="2" data-v-4a18db6b></rect><line x1="9" y1="3" x2="9" y2="21" data-v-4a18db6b></line><line x1="15" y1="3" x2="15" y2="21" data-v-4a18db6b></line><line x1="3" y1="9" x2="21" y2="9" data-v-4a18db6b></line><line x1="3" y1="15" x2="21" y2="15" data-v-4a18db6b></line></svg></div><p data-v-4a18db6b>Start a new conversation</p>',2)]))),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(s.currentMessages,(a=>((0,n.uX)(),(0,n.CE)("div",{key:`msg-${a.id}-${a.role}-${a.feedback||"none"}`,class:"message-group"},["user"===a.role?((0,n.uX)(),(0,n.CE)("div",It,[(0,n.Lk)("div",bt,[(0,n.Lk)("div",Lt,(0,i.v_)(a.question||""),1)])])):(0,n.Q3)("",!0),"user"===a.role&&a.ans?((0,n.uX)(),(0,n.CE)("div",At,[(0,n.Lk)("div",$t,[(0,n.Lk)("div",{class:"message-text",innerHTML:r.formatAnswer(a.ans)},null,8,Tt)]),(0,n.Lk)("div",Et,[((0,n.uX)(),(0,n.CE)("button",{key:`thumbs-up-${a.id}-${r.feedbackUpdateTrigger}`,class:(0,i.C4)(["action-btn thumbs-up",{active:"positive"===r.messageFeedbackStates[a.id],disabled:s.isStreaming||r.isMessageStreaming(a.id)}]),onClick:t=>!s.isStreaming&&!r.isMessageStreaming(a.id)&&e.$emit("submitFeedback",a.id,"positive"),disabled:s.isStreaming||r.isMessageStreaming(a.id),title:r.getFeedbackButtonTitle(a.id,"positive")},t[1]||(t[1]=[(0,n.Lk)("svg",{class:"action-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"})],-1)]),10,Rt)),((0,n.uX)(),(0,n.CE)("button",{key:`thumbs-down-${a.id}-${r.feedbackUpdateTrigger}`,class:(0,i.C4)(["action-btn thumbs-down",{active:"negative"===r.messageFeedbackStates[a.id],disabled:s.isStreaming||r.isMessageStreaming(a.id)}]),onClick:t=>!s.isStreaming&&!r.isMessageStreaming(a.id)&&e.$emit("submitFeedback",a.id,"negative"),disabled:s.isStreaming||r.isMessageStreaming(a.id),title:r.getFeedbackButtonTitle(a.id,"negative")},t[2]||(t[2]=[(0,n.Lk)("svg",{class:"action-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"})],-1)]),10,xt))])])):(0,n.Q3)("",!0)])))),128)),s.isStreaming&&s.streamingVisible?((0,n.uX)(),(0,n.CE)("div",{key:"streaming-message",class:"message assistant streaming",style:(0,i.Tr)({minHeight:s.lastMessageHeight+"px",opacity:1})},[(0,n.Lk)("div",Ot,[(0,n.Lk)("div",Ut,[(0,n.eW)((0,i.v_)(s.streamingMessage),1),t[3]||(t[3]=(0,n.Lk)("span",{class:"cursor"},"|",-1))],512)],512)],4)):(0,n.Q3)("",!0)])])}const Pt={name:"MessageList",props:{currentMessages:{type:Array,default:()=>[]},isStreaming:{type:Boolean,default:!1},streamingMessage:{type:String,default:""},streamingVisible:{type:Boolean,default:!1},lastMessageHeight:{type:Number,default:0}},emits:["submitFeedback"],computed:{feedbackUpdateTrigger(){return this.$store.state.feedbackUpdateTrigger||0},messageFeedbackStates(){const e={};return this.currentMessages.forEach((t=>{e[t.id]=t.feedback})),e}},watch:{isStreaming(e){console.log("🔄 스트리밍 상태 변경:",e)},streamingVisible(e){console.log("🔄 스트리밍 영역 표시 상태 변경:",e)},feedbackUpdateTrigger(){console.log("🔄 피드백 트리거 변경 감지:",this.feedbackUpdateTrigger),this.$forceUpdate()},messages:{handler(){console.log("🔄 메시지 배열 변경 감지"),this.$forceUpdate()},deep:!0},"$store.state.currentConversation":{handler(){console.log("🔄 currentConversation 변경 감지"),this.$forceUpdate()},deep:!0}},methods:{formatAnswer(e){if(!e)return"";let t=e;t=t.replace(/^### (.*$)/gm,'<h3 class="markdown-h3">$1</h3>'),t=t.replace(/^## (.*$)/gm,'<h2 class="markdown-h2">$1</h2>'),t=t.replace(/^# (.*$)/gm,'<h1 class="markdown-h1">$1</h1>'),t=t.replace(/\*\*(.*?)\*\*/g,'<strong class="markdown-bold">$1</strong>');const s=/(\|[^\n]+\|\n)+/g;return t=t.replace(s,(e=>{const t=e.trim().split("\n");let s='<table class="markdown-table">';return t.forEach(((e,t)=>{if(e.trim()&&!e.match(/^\|[-\s|]+\|$/)){const a=e.split("|").map((e=>e.trim())).filter((e=>e));a.length>0&&(s+="<tr>",a.forEach((e=>{s+=0===t?`<th class="markdown-th">${e}</th>`:`<td class="markdown-td">${e}</td>`})),s+="</tr>")}})),s+="</table>",s})),t=t.replace(/^- (.*$)/gm,'<li class="markdown-li">$1</li>'),t=t.replace(/(<li class="markdown-li">.*<\/li>)/s,'<ul class="markdown-ul">$1</ul>'),t=t.replace(/^\d+\. (.*$)/gm,'<li class="markdown-oli">$1</li>'),t=t.replace(/(<li class="markdown-oli">.*<\/li>)/s,'<ol class="markdown-ol">$1</ol>'),t=t.replace(/```([\s\S]*?)```/g,'<pre class="markdown-code"><code>$1</code></pre>'),t=t.replace(/`([^`]+)`/g,'<code class="markdown-inline-code">$1</code>'),t=t.replace(/\n\n/g,'</p><p class="markdown-p">'),t=t.replace(/\n/g,"<br>"),t=(t.includes('<p class="markdown-p">'),`<p class="markdown-p">${t}</p>`),t},getMessageFeedback(e){const t=this.currentMessages.find((t=>t.id===e)),s=t?t.feedback:null;return console.log("🔍 getMessageFeedback:",{messageId:e,feedback:s,messageExists:!!t,trigger:this.feedbackUpdateTrigger}),s},isMessageStreaming(e){const t=this.currentMessages.find((t=>t.id===e));if(!t)return!1;const s=!t.ans||""===t.ans.trim();return s&&this.isStreaming&&this.streamingVisible},getFeedbackButtonTitle(e,t){const s=this.messageFeedbackStates[e],a=this.isStreaming||this.isMessageStreaming(e);if(a)return"답변이 완성되면 피드백을 남길 수 있습니다";const o=s===t?"none":t;return`Message ID: ${e}, Current: ${s||"none"}, Toggle to: ${o}`}}},Dt=(0,H.A)(Pt,[["render",Mt],["__scopeId","data-v-4a18db6b"]]),Nt=Dt,Kt={class:"chat-input-container"},Ft={class:"input-wrapper"},Bt=["disabled"],jt=["disabled"],Qt={key:0},Jt={key:1,class:"loading-spinner"};function Xt(e,t,s,o,r,i){return(0,n.uX)(),(0,n.CE)("div",Kt,[(0,n.Lk)("div",Ft,[(0,n.bo)((0,n.Lk)("textarea",{"onUpdate:modelValue":t[0]||(t[0]=e=>r.userInput=e),class:"chat-input",placeholder:"질문을 입력하세요...",onKeydown:t[1]||(t[1]=(0,a.jR)((0,a.D$)(((...e)=>i.handleEnterKey&&i.handleEnterKey(...e)),["prevent"]),["enter"])),disabled:s.isLoading||s.isStreaming,ref:"inputField",rows:"1",onInput:t[2]||(t[2]=(...e)=>i.handleInputChange&&i.handleInputChange(...e))},null,40,Bt),[[a.Jo,r.userInput]]),(0,n.Lk)("button",{class:"send-btn",disabled:!r.userInput.trim()||s.isLoading||s.isStreaming,onClick:t[3]||(t[3]=t=>e.$emit("sendMessage"))},[s.isLoading?((0,n.uX)(),(0,n.CE)("span",Jt)):((0,n.uX)(),(0,n.CE)("span",Qt,t[4]||(t[4]=[(0,n.Lk)("svg",{class:"send-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[(0,n.Lk)("path",{d:"M22 2L11 13"}),(0,n.Lk)("path",{d:"M22 2l-7 20-4-9-9-4 20-7z"})],-1)])))],8,jt)])])}const Ht={name:"ChatInput",props:{isLoading:{type:Boolean,default:!1},isStreaming:{type:Boolean,default:!1}},emits:["sendMessage","inputChange"],data(){return{userInput:""}},methods:{handleEnterKey(e){e.shiftKey&&"Enter"===e.key||this.$emit("sendMessage")},handleInputChange(){this.$emit("inputChange",this.userInput),this.adjustTextareaHeight()},adjustTextareaHeight(){const e=this.$refs.inputField;if(e)try{e.style.height="auto";const t=Math.min(e.scrollHeight,150);e.style.height=t+"px"}catch(t){console.warn("Textarea height adjustment failed:",t)}},clearInput(){this.userInput="",this.adjustTextareaHeight()},focusInput(){if(this.$refs.inputField&&this.$refs.inputField.focus)try{this.$refs.inputField.focus()}catch(e){console.warn("Focus failed:",e)}}},mounted(){this.$nextTick((()=>{this.adjustTextareaHeight()}))}},Gt=(0,H.A)(Ht,[["render",Xt],["__scopeId","data-v-dbc7c99a"]]),qt=Gt;var Vt=s(144);function zt(){const e=(0,Vt.KR)(!1),t=(0,Vt.KR)(0),s=(0,Vt.KR)(""),a=(0,Vt.KR)([]),o=(0,Vt.KR)(!1),r=(0,Vt.KR)([]),i=(0,Vt.KR)([]),l=(0,Vt.KR)(!1),c=(0,Vt.KR)(!1),u=(0,Vt.KR)(""),g=(0,Vt.KR)(""),d=(0,Vt.KR)(!1),h=(0,Vt.KR)(""),p=(0,Vt.KR)(!1),m=(0,Vt.KR)(""),v=(0,Vt.KR)(""),w=(0,Vt.KR)(null),k=(0,Vt.KR)(null),f=(0,Vt.KR)(null),y=(0,Vt.KR)(!1),S=(0,Vt.KR)(null),C=(0,Vt.KR)(0),_=(0,Vt.KR)(!0),I=(0,Vt.KR)(!1),b=(0,Vt.KR)(!0),L=(0,Vt.KR)(!1),A=(0,Vt.KR)(!1),$=(0,n.EW)((()=>t.value/4*100)),T=()=>{e.value=!1,t.value=0,s.value="",a.value=[],r.value=[],u.value="",h.value="",v.value="",w.value=null,o.value=!1,c.value=!1,k.value=null,f.value=null},E=()=>{T(),b.value=!0},R=(e,t)=>{const s=e.toLowerCase();if(0===t)return"원본";if(s.includes("분석")||s.includes("analysis")||s.includes("데이터"))return"분석";if(s.includes("개선")||s.includes("향상")||s.includes("최적화"))return"개선";if(s.includes("전략")||s.includes("계획")||s.includes("방안"))return"전략";if(s.includes("성과")||s.includes("결과")||s.includes("효과"))return"성과";if(s.includes("관리")||s.includes("운영")||s.includes("시스템"))return"관리";if(s.includes("기술")||s.includes("개발")||s.includes("솔루션"))return"기술";if(s.includes("비즈니스")||s.includes("사업")||s.includes("경영"))return"비즈니스";if(s.includes("프로세스")||s.includes("절차")||s.includes("워크플로우"))return"프로세스";{const e=["핵심","관련","확장","부가"];return e[(t-1)%e.length]}};return{showLanggraph:e,currentStep:t,originalInput:s,augmentedKeywords:a,isSearching:o,searchResults:r,searchedDocuments:i,hasSearchCompleted:l,isGeneratingAnswer:c,finalAnswer:u,streamingAnswer:g,isStreamingAnswer:d,analysisImageUrl:h,imageLoadFailed:p,failedImageUrl:m,lastImageUrl:v,langGraphError:w,extractedKeywords:k,extractedDbSearchTitle:f,isDoneProcessed:y,lastRestoredConversationId:S,lastRestoredMessageCount:C,isNewConversation:_,isRestoringConversation:I,isFirstQuestionInSession:b,isFollowupQuestion:L,isLanggraphJustCompleted:A,progressPercentage:$,resetLanggraph:T,resetLanggraphState:E,categorizeKeyword:R}}function Wt(){const e=(0,o.Pj)(),t=(0,Vt.KR)(!1),s=(0,Vt.KR)(!1),a=(0,Vt.KR)(!1),r=(0,Vt.KR)(""),n=e=>{if(!e)return"";let t=e;t=t.replace(/^### (.*$)/gm,'<h3 class="markdown-h3">$1</h3>'),t=t.replace(/^## (.*$)/gm,'<h2 class="markdown-h2">$1</h2>'),t=t.replace(/^# (.*$)/gm,'<h1 class="markdown-h1">$1</h1>'),t=t.replace(/\*\*(.*?)\*\*/g,'<strong class="markdown-bold">$1</strong>');const s=/(\|[^\n]+\|\n)+/g;return t=t.replace(s,(e=>{const t=e.trim().split("\n");let s='<table class="markdown-table">';return t.forEach(((e,t)=>{if(e.trim()&&!e.match(/^\|[-\s|]+\|$/)){const a=e.split("|").map((e=>e.trim())).filter((e=>e));a.length>0&&(s+="<tr>",a.forEach((e=>{s+=0===t?`<th class="markdown-th">${e}</th>`:`<td class="markdown-td">${e}</td>`})),s+="</tr>")}})),s+="</table>",s})),t=t.replace(/^- (.*$)/gm,'<li class="markdown-li">$1</li>'),t=t.replace(/(<li class="markdown-li">.*<\/li>)/s,'<ul class="markdown-ul">$1</ul>'),t=t.replace(/^\d+\. (.*$)/gm,'<li class="markdown-oli">$1</li>'),t=t.replace(/(<li class="markdown-oli">.*<\/li>)/s,'<ol class="markdown-ol">$1</ol>'),t=t.replace(/```([\s\S]*?)```/g,'<pre class="markdown-code"><code>$1</code></pre>'),t=t.replace(/`([^`]+)`/g,'<code class="markdown-inline-code">$1</code>'),t=t.replace(/\n\n/g,'</p><p class="markdown-p">'),t=t.replace(/\n/g,"<br>"),t=(t.includes('<p class="markdown-p">'),`<p class="markdown-p">${t}</p>`),t},i=(e,t)=>{const s=t.find((t=>t.id===e));return s?s.feedback:null},l=async(t,s)=>{await e.dispatch("submitFeedback",{messageId:t,feedback:s})},c=async()=>{if(s.value)console.log("[HOME] 새 대화 생성 중 - 중복 실행 방지");else{s.value=!0,console.log("🔄 새 대화 UI 초기화 시작...");try{const t=await e.dispatch("createConversation");t?(e.commit("setCurrentConversation",t),console.log("✅ 새 대화 생성 완료:",t.id)):(console.error("❌ 새 대화 생성 실패"),alert("새 대화 생성에 실패했습니다. 다시 시도해주세요."))}catch(t){console.error("❌ 새 대화 생성 오류:",t),alert("새 대화 생성 중 오류가 발생했습니다.")}s.value=!1,console.log("✅ 새 대화 UI 초기화 완료")}};return{isLoading:t,isCreatingConversation:s,isSavingMessage:a,saveStatus:r,formatAnswer:n,getMessageFeedback:i,submitFeedback:l,newConversation:c}}function Yt(){const e=(0,Vt.KR)(!1),t=(0,Vt.KR)(""),s=(0,Vt.KR)(!1),a=async(e,t)=>{const s=new AbortController;window.sseController=s,console.log("🚀 [SSE] LangGraph 스트리밍 요청 시작",{inputPreview:e?.slice(0,50)||"",hasToken:!!localStorage.getItem("access_token")});try{const a=localStorage.getItem("access_token"),o=await fetch("http://localhost:8000/api/langgraph/stream",{method:"POST",headers:{"Content-Type":"application/json",Authorization:a?`Bearer ${a}`:""},body:JSON.stringify({question:e}),signal:s.signal});if(!o.ok)throw console.error("❌ [SSE] 스트리밍 응답 실패",{status:o.status,statusText:o.statusText}),new Error(`SSE 요청 실패: ${o.status}`);console.log("✅ [SSE] 스트리밍 응답 수신 성공 - 데이터 읽기 시작");const r=o.body.getReader(),n=new TextDecoder;let i="",l=null;const c=async()=>{let e=i.indexOf("\n\n");while(-1!==e){const a=i.slice(0,e);i=i.slice(e+2);const o=a.split("\n");let r="";for(const e of o)e.trim()&&e.startsWith("data:")&&(r+=e.slice(5).trimStart());if(r){if("[DONE]"===r)return console.log("🏁 [SSE] [DONE] 토큰 수신 - 스트림 종료 예정"),!0;try{const s=JSON.parse(r),a=s.generator_id||s.generatorId||l;if(a&&a!==l&&(l=a),console.log("🧭 [SSE] 파싱된 메시지",{generatorId:a||"unknown",stage:s.stage||"unknown",status:s.status||"unknown",node:s.node_name||s.node||"n/a",event:s.event||"n/a",hasResult:!!s.result}),s.heartbeat){console.log("❤️ [SSE] 하트비트 수신"),e=i.indexOf("\n\n");continue}if(s.error)throw console.error("❌ SSE 에러:",s.error),new Error(s.error);await t.handleSSEMessage({...s,generator_id:s.generator_id||s.generatorId||l})}catch(s){console.error("❌ SSE 메시지 파싱 오류:",s,"Data:",r)}e=i.indexOf("\n\n")}else console.log("⚠️ [SSE] data 필드를 찾지 못한 이벤트",a),e=i.indexOf("\n\n")}return!1};while(1){const{done:e,value:t}=await r.read();if(e){console.log("ℹ️ [SSE] 스트림 종료 신호 수신 (reader done)");const e=n.decode();e&&(i+=e);const t=await c();if(t)return;break}const s=n.decode(t,{stream:!0});if(!s)continue;i+=s,console.log("📦 [SSE] 원시 청크 수신",{chunk:s,bufferLength:i.length});const a=await c();if(a)return}}catch(a){if("AbortError"===a.name)return void console.log("⏹️ [SSE] AbortController에 의해 스트림이 중단됨");throw console.error("❌ SSE 스트리밍 오류:",a),a}};return{isStreaming:e,streamingMessage:t,streamingVisible:s,executeLangGraphWithSSE:a}}function Zt(){const e=(0,Vt.KR)(!1),t=(0,Vt.KR)(null),s=(0,Vt.KR)(0),a=(0,Vt.KR)(0),o=(0,Vt.KR)(null),r=(0,Vt.KR)(!1),n=e=>{r.value||(r.value=!0,requestAnimationFrame((()=>{if(e){const t=e;t.scrollTop=t.scrollHeight}r.value=!1})))},i=()=>{const e=document.querySelector(".langgraph-container");e&&(e.scrollIntoView({behavior:"smooth",block:"start"}),e.scrollTop=0)},l=e=>{const t=document.querySelector(".langgraph-container");if(t&&(t.scrollTop=t.scrollHeight,e)){const t=e;t.scrollTop=t.scrollHeight}},c=e=>{e&&(a.value=e.scrollTop)},u=e=>{e&&(e.scrollTop=a.value)},g=e=>{if(e&&e.focus)try{e.focus()}catch(t){console.warn("Focus failed:",t)}},d=e=>{if(e)try{e.style.height="auto";const t=Math.min(e.scrollHeight,150);e.style.height=t+"px"}catch(t){console.warn("Textarea height adjustment failed:",t)}};return{scrollThrottled:e,scrollTimeout:t,lastMessageHeight:s,lastScrollPosition:a,observer:o,scrollPending:r,scrollToBottom:n,scrollToLanggraph:i,scrollToLanggraphBottom:l,preserveScrollPosition:c,restoreScrollPosition:u,safeFocus:g,adjustTextareaHeight:d}}function es(e){if(!e||"object"!==typeof e)return void console.warn("⚠️ [SSE] 로그를 위한 데이터가 올바르지 않음:",e);const t=e.generator_id||e.generatorId||"unknown",s=e.stage||"unknown",a=e.status||"unknown",o=e.node_name||e.node||"n/a",r=e.event||"n/a",n=e.timestamp||e.time||null,i=`📡 [SSE] stage=${s} status=${a} generator=${t}`;try{console.groupCollapsed(i),console.log("🔖 generator_id:",t),console.log("🧩 stage:",s),console.log("📍 status:",a),console.log("🧱 node:",o),console.log("🎯 event:",r),n&&console.log("⏱️ timestamp:",n),console.log("📦 has result:",!!e.result),e.result&&console.log("📦 result keys:",Object.keys(e.result)),console.log("📝 raw message:",e)}finally{console.groupEnd()}}async function ts(e,t){if(es(e),"DONE"===e.stage)return await ss(e,t);switch(e.stage){case"A":await as(e,t);break;case"B":await os(e,t);break;case"C":await rs(e,t);break;case"D":await ns(e,t);break;case"E":await is(e,t);break;case"TEST":await ls(e,t);break;case"ERROR":await cs(e,t);break;default:}}async function ss(e,t){if(t.langgraph.isDoneProcessed.value)return;t.langgraph.isDoneProcessed.value=!0,t.messages.isLoading.value=!1,t.langgraph.isSearching.value=!1,t.langgraph.isGeneratingAnswer.value=!1,t.langgraph.isStreamingAnswer.value=!1,t.langgraph.currentStep.value=4,console.log("🖼️ [SSE DONE] data.result 구조:",Object.keys(e.result||{})),console.log("🖼️ [SSE DONE] data.result.response 존재:",!!e.result?.response),e.result&&e.result.response&&(console.log("🖼️ [SSE DONE] data.result.response 구조:",Object.keys(e.result.response||{})),console.log("🖼️ [SSE DONE] data.result.response.analysis_image_url 값:",e.result.response.analysis_image_url)),e.result&&e.result.analysis_image_url?(t.langgraph.analysisImageUrl.value=e.result.analysis_image_url,console.log("✅ [SSE DONE] 분석 이미지 URL 설정 (직접):",t.langgraph.analysisImageUrl.value)):e.result&&e.result.response&&e.result.response.analysis_image_url?(t.langgraph.analysisImageUrl.value=e.result.response.analysis_image_url,console.log("✅ [SSE DONE] 분석 이미지 URL 설정 (response 내부):",t.langgraph.analysisImageUrl.value)):console.warn("⚠️ [SSE DONE] analysis_image_url을 찾을 수 없음"),!t.langgraph.finalAnswer.value&&t.langgraph.streamingAnswer.value&&(t.langgraph.finalAnswer.value=t.langgraph.streamingAnswer.value),t.langgraph.isLanggraphJustCompleted.value=!0,t.langgraph.isFollowupQuestion.value=!0,console.log("✅ 최초 질문 완료 - isFollowupQuestion을 true로 설정");const s=t.langgraph.finalAnswer.value||t.langgraph.streamingAnswer.value;if(console.log("📝 [DONE] 답변을 user 메시지의 ans 필드에 저장 시작:",{hasAnswer:!!s,answerLength:s?s.length:0,hasConversation:!!t.$store.state.currentConversation,conversationId:t.$store.state.currentConversation?.id,currentMessageCount:t.$store.state.currentConversation?.messages?.length}),s&&t.$store.state.currentConversation){console.log("✅ [DONE] 조건 충족 - user 메시지 ans 필드 업데이트 진행");const e=t.$store.state.currentConversation;if(e&&e.messages&&e.messages.length>0){const t=e.messages.filter((e=>"user"===e.role));if(t.length>0){const e=t[t.length-1];e.ans=s,console.log("✅ [DONE] user 메시지 ans 필드 업데이트 완료:",e.id)}}try{console.log("🖼️ [DONE] saveLangGraphMessage 호출 전 analysisImageUrl:",t.langgraph.analysisImageUrl.value);const e={result:{response:{answer:s,analysis_image_url:t.langgraph.analysisImageUrl.value},keyword:t.langgraph.extractedKeywords.value,candidates_total:t.langgraph.extractedDbSearchTitle.value?t.langgraph.extractedDbSearchTitle.value.map((e=>({res_payload:{document_name:e}}))):[]}},a=await t.saveLangGraphMessage(e);console.log("✅ [DONE] LangGraph 메시지 저장 완료:",a),console.log("✅ [DONE] 대화 목록 새로고침 생략 (UI refresh 방지)")}catch(a){console.error("❌ [DONE] LangGraph 메시지 저장 실패:",a)}}else console.warn("⚠️ [DONE] 답변 메시지 추가 조건 미충족:",{answerToAdd:s?.substring(0,50),currentConversation:t.$store.state.currentConversation?.id});console.log("✅ [DONE] 랭그래프 UI 유지:",{showLanggraph:t.langgraph.showLanggraph.value,currentStep:t.langgraph.currentStep.value,hasAnswer:!!t.langgraph.finalAnswer.value}),t.scrollToLanggraph(),setTimeout((()=>{t.langgraph.isLanggraphJustCompleted.value=!1,console.log("✅ [DONE] 랭그래프 완료 플래그 해제")}),5e3)}async function as(e,t){"started"===e.status?(t.langgraph.currentStep.value=1,!t.langgraph.originalInput.value&&e.result&&e.result.question&&(t.langgraph.originalInput.value=e.result.question),console.log("🔄 A단계 시작 - 원본 입력:",t.langgraph.originalInput.value)):e.status}async function os(e,t){"started"===e.status?t.langgraph.currentStep.value=2:"completed"===e.status&&e.result&&e.result.keywords&&(t.langgraph.augmentedKeywords.value=e.result.keywords.map(((e,s)=>({id:`keyword-${s}`,text:e,category:t.langgraph.categorizeKeyword(e,s)}))),t.langgraph.extractedKeywords.value=e.result.keywords)}async function rs(e,t){"started"===e.status?(t.langgraph.currentStep.value=3,t.langgraph.isSearching.value=!0):"completed"===e.status&&(t.langgraph.isSearching.value=!1,e.result&&e.result.search_results&&(t.langgraph.searchResults.value=e.result.search_results,t.langgraph.searchedDocuments.value=e.result.document_titles||[],t.langgraph.extractedDbSearchTitle.value=e.result.document_titles||[]))}async function ns(e,t){"started"===e.status||"completed"===e.status||"streaming"===e.status&&e.result&&e.result.content&&(t.langgraph.streamingAnswer.value=(t.langgraph.streamingAnswer.value||"")+e.result.content,t.langgraph.isStreamingAnswer.value=!0,t.langgraph.isGeneratingAnswer.value=!0,t.langgraph.currentStep.value=4,t.$store.commit("updateStreamingMessage",t.langgraph.streamingAnswer.value))}async function is(e,t){"started"===e.status?(t.langgraph.isGeneratingAnswer.value=!0,t.langgraph.currentStep.value=4):"completed"===e.status?(t.langgraph.isGeneratingAnswer.value=!1,t.langgraph.isStreamingAnswer.value=!1,e.result&&e.result.answer&&(t.langgraph.finalAnswer.value=e.result.answer)):"streaming"===e.status&&e.result&&e.result.content&&(t.langgraph.streamingAnswer.value=(t.langgraph.streamingAnswer.value||"")+e.result.content,t.langgraph.isStreamingAnswer.value=!0,t.langgraph.isGeneratingAnswer.value=!0,t.$store.commit("updateStreamingMessage",t.langgraph.streamingAnswer.value))}async function ls(){}async function cs(e,t){if(console.error("❌ SSE 에러 메시지:",e.error),t.messages.isLoading.value=!1,t.langgraph.isSearching.value=!1,t.langgraph.isGeneratingAnswer.value=!1,t.langgraph.isStreamingAnswer.value=!1,t.$store.state.currentConversation){const s={id:Date.now()+Math.random(),conversation_id:t.$store.state.currentConversation.id,role:"assistant",question:null,ans:`오류가 발생했습니다: ${e.error}`,created_at:(new Date).toISOString()};t.$store.commit("addMessageToCurrentConversation",s)}}async function us(e,t){if(t.messages.isLoading.value||t.langgraph.isSearching.value)console.log("이미 랭그래프가 실행 중입니다. 중복 실행 방지.");else{console.log("🔄 LangGraph 4단계 분석 시작:",e),t.messages.isLoading.value=!0,t.langgraph.isSearching.value=!1,t.langgraph.isGeneratingAnswer.value=!1,t.langgraph.isStreamingAnswer.value=!1,t.langgraph.isDoneProcessed.value=!1,t.langgraph.originalInput.value=e,t.langgraph.showLanggraph.value=!0,t.langgraph.currentStep.value=0,t.langgraph.streamingAnswer.value="",t.langgraph.finalAnswer.value="",t.langgraph.analysisImageUrl.value="";try{const s=await gs(e,t);if(console.log("✅ 영구 메시지 ID 발급 완료:",s),t.$store.state.currentConversation){const a={id:Date.now()+1e3*Math.random(),conversation_id:t.$store.state.currentConversation.id,role:"user",question:e,ans:null,backend_id:s,created_at:(new Date).toISOString()};t.$store.commit("addMessageToCurrentConversation",a)}await ds(e,t,s)}catch(s){console.error("❌ LangGraph 실행 오류:",s),await hs(e,s,t)}}}async function gs(e,t){try{const s=localStorage.getItem("access_token");if(!s)throw new Error("인증 토큰이 없습니다.");const a=t.$store.state.currentConversation?.id;if(!a)throw new Error("현재 대화가 없습니다.");const o={question:e,q_mode:"search",keyword:null,db_contents:null,image:null};console.log("📋 prepare_message API 호출:",o);const r=await fetch(`http://localhost:8000/api/conversations/${a}/messages/prepare`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(o)});if(!r.ok){const e=await r.text();throw new Error(`prepare_message API 호출 실패: ${r.status} ${e}`)}const n=await r.json();if(console.log("✅ prepare_message 응답:",n),n.userMessage&&n.userMessage.id)return n.userMessage.id;throw new Error("영구 메시지 ID를 받지 못했습니다.")}catch(s){throw console.error("❌ prepare_message API 호출 오류:",s),s}}async function ds(e,t,s){const a=new AbortController;window.sseController=a;try{const r=localStorage.getItem("access_token");if(!r)throw new Error("인증 토큰이 없습니다.");const n={question:e,conversation_id:t.$store.state.currentConversation?.id||null,message_id:s,generate_image:!1,include_langgraph_context:!1,langgraph_context:null};console.log("🚀 SSE 스트리밍 요청 시작:",n);const i="http://localhost:8000/api/langgraph/stream";console.log("🎯 랭그래프 엔드포인트:",i),console.log("🎯 isFollowupQuestion:",t.langgraph.isFollowupQuestion.value);const l=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(n),signal:a.signal});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=l.body.getReader(),u=new TextDecoder;let g="",d="",h=!1;while(!h){const{done:e,value:s}=await c.read();let a;h=e,s&&(g+=u.decode(s,{stream:!0}));while(-1!==(a=g.indexOf("\n"))){const e=g.slice(0,a);g=g.slice(a+1);const s=e.trimEnd();if(s){if(s.startsWith("data:")){const e=s.slice(5).trimStart();d&&(d+="\n"),d+=e}}else if(d){const e=d.trim();if(d="",!e)continue;if("[DONE]"===e){console.log("📡 SSE 스트림 종료"),h=!0;break}try{const s=JSON.parse(e);await ts(s,t)}catch(o){console.warn("📡 SSE 메시지 파싱 오류:",o,"\n📄 원본 데이터:",e)}}}if(h){if(d){const e=d.trim();if(d="",e&&"[DONE]"!==e)try{const s=JSON.parse(e);await ts(s,t)}catch(o){console.warn("📡 SSE 메시지 파싱 오류 (스트림 종료 시):",o,"\n📄 원본 데이터:",e)}}"[DONE]"===g.trim()?console.log("📡 SSE 스트림 종료 (잔여 버퍼)"):console.log("📡 SSE 스트림 완료")}}}catch(r){if("AbortError"!==r.name)throw console.error("❌ SSE 스트리밍 오류:",r),r;console.log("📡 SSE 스트림 중단됨")}finally{t.messages.isLoading.value=!1,t.langgraph.isSearching.value=!1,t.langgraph.isGeneratingAnswer.value=!1,t.langgraph.isStreamingAnswer.value=!1,t.langgraph.isFollowupQuestion.value=!0,console.log("✅ 최초 질문 완료 (SSE) - isFollowupQuestion을 true로 설정")}}async function hs(e,t,s){s.langgraph.langGraphError.value=t,s.langgraph.currentStep.value=1,s.messages.isLoading.value=!1,s.langgraph.isSearching.value=!1;const a=`죄송합니다. 분석 중 오류가 발생했습니다: ${t.message}`;await ps(e,a,s),s.langgraph.isFollowupQuestion.value=!0,console.log("✅ 최초 질문 완료 (폴백) - isFollowupQuestion을 true로 설정")}async function ps(e,t,s){try{if(!s.$store.state.currentConversation)return void console.error("⚠️ 폴백 메시지 저장 실패: 현재 대화가 없습니다.");const a=s.$store.state.currentConversation.id,o={id:Date.now()+Math.random(),conversation_id:a,role:"user",question:e,ans:null,created_at:(new Date).toISOString()};s.$store.commit("addMessageToCurrentConversation",o),o.ans=t,console.log("✅ 폴백 메시지 저장 완료")}catch(a){console.error("❌ 폴백 메시지 저장 실패:",a)}}async function ms(e,t,s){try{if(!t){if(!s.$store.state.currentConversation)return void console.error("⚠️ 추가 질문 실행 실패: 현재 대화가 없습니다.");t=s.$store.state.currentConversation.id}console.log("💬 추가 질문 스트리밍 답변 실행 시작:",e);const o=localStorage.getItem("access_token");if(!o)throw new Error("인증 토큰이 없습니다.");const r=await fetch(`http://localhost:8000/api/conversations/${t}/messages/prepare`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({question:e,q_mode:"add",conversation_id:t})});if(!r.ok)throw new Error(`Prepare message failed: ${r.status}`);const n=await r.json();console.log("✅ 추가 질문 영구 메시지 ID 발급 완료:",n);const i={id:`${n.userMessage.id}-user`,conversation_id:t,role:"user",question:e,ans:"",created_at:(new Date).toISOString(),backend_id:n.userMessage.id};s.$store.commit("addMessageToCurrentConversation",i),s.$store.commit("updateStreamingMessage",""),s.$store.commit("setIsStreaming",!1),await s.$nextTick(),s.$store.commit("setIsStreaming",!0),s.$store.commit("updateStreamingMessage",""),s.sse.streamingVisible.value=!0,console.log("👀 추가 질문 스트리밍 영역 표시 시작"),await s.$nextTick();const l={question:e,conversation_id:t,message_id:n.userMessage.id,generate_image:!1,include_langgraph_context:!1,langgraph_context:null,q_mode:"add"};console.log("📤 추가 질문 요청 데이터:",l),console.log("📤 추가 질문 요청 상세:"),console.log("  - question:",e),console.log("  - conversation_id:",t),console.log("  - q_mode:","add"),console.log("  - generate_image:",!1);const c=s.$store.state.currentConversation;c&&c.messages?(console.log("📋 현재 대화 메시지 히스토리:"),console.log("  - 총 메시지 수:",c.messages.length),c.messages.forEach(((e,t)=>{console.log(`  - 메시지 ${t+1}:`,{id:e.id,role:e.role,question:e.question?e.question.substring(0,100)+"...":"없음",ans:e.ans?e.ans.substring(0,100)+"...":"없음",created_at:e.created_at})}))):console.log("⚠️ 현재 대화 또는 메시지가 없습니다");const u=await fetch("http://localhost:8000/api/normal_llm/followup/stream",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(l)});if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);let g="";const d=u.headers.get("content-type")||"",h=d.includes("text/event-stream");if(console.log("📡 추가 질문 스트림 콘텐츠 타입:",d||"알 수 없음"),h){const e=u.body.getReader(),t=new TextDecoder;let a="",o=!1;const r=()=>{let e=a.indexOf("\n\n");while(-1!==e){const r=a.slice(0,e);a=a.slice(e+2);const n=r.split("\n").filter((e=>e.startsWith("data: ")));if(0===n.length){e=a.indexOf("\n\n");continue}const i=n.map((e=>e.slice(6))).join("\n");if("[DONE]"===i)return console.log("📡 추가 질문 스트리밍 종료 신호 수신"),void(o=!0);try{const e=JSON.parse(i);e.content&&(g+=e.content,s.$store.commit("updateStreamingMessage",g),g.length>0&&!s.sse.streamingVisible.value&&(s.sse.streamingVisible.value=!0,console.log("👀 추가 질문 스트리밍 영역 활성화 (데이터 수신)")))}catch(t){console.warn("📡 추가 질문 스트리밍 데이터 파싱 오류:",t,"\n📄 원본 데이터:",i)}e=a.indexOf("\n\n")}};while(!o){const{done:s,value:o}=await e.read();if(o&&(a+=t.decode(o,{stream:!s}),r()),s){a+=t.decode(new Uint8Array,{stream:!1}),r(),console.log("📡 추가 질문 이벤트 스트리밍 완료");break}}}else{const e=u.body.getReader(),t=new TextDecoder;while(1){const{done:a,value:o}=await e.read();if(o){const e=t.decode(o,{stream:!a});e&&(g+=e,s.$store.commit("updateStreamingMessage",g),g.length>0&&!s.sse.streamingVisible.value&&(s.sse.streamingVisible.value=!0,console.log("👀 추가 질문 스트리밍 영역 활성화 (텍스트 데이터)")))}if(a){console.log("📡 추가 질문 텍스트 스트리밍 완료");break}}}if(g){s.$store.commit("setIsStreaming",!1),s.$store.commit("updateStreamingMessage",""),s.sse.streamingVisible.value=!1,await s.$nextTick();try{const e=await fetch(`http://localhost:8000/api/messages/${n.userMessage.id}/complete`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({assistant_response:g,image_url:null})});e.ok?s.$store.commit("updateMessageAnswer",{messageId:n.userMessage.id,answer:g}):console.warn("⚠️ 추가 질문 메시지 완료 처리 실패:",e.status)}catch(a){console.warn("⚠️ 추가 질문 메시지 완료 처리 오류:",a)}}else s.$store.commit("setIsStreaming",!1),s.$store.commit("updateStreamingMessage",""),s.sse.streamingVisible.value=!1;console.log("✅ 추가 질문 처리 완료")}catch(o){console.error("❌ 추가 질문 처리 오류:",o);const t=`죄송합니다. 추가 질문 처리 중 오류가 발생했습니다: ${o.message}`;if(s.$store.state.currentConversation){const a={id:Date.now()+Math.random(),conversation_id:s.$store.state.currentConversation.id,role:"user",question:e,ans:t,created_at:(new Date).toISOString()};s.$store.commit("addMessageToCurrentConversation",a)}s.$store.commit("setIsStreaming",!1),s.$store.commit("updateStreamingMessage",""),s.sse.streamingVisible.value=!1}}async function vs(e,t=null,s){return await ms(e,t,s)}async function ws(e,t){if(t.langgraph.isRestoringConversation.value=!0,t.langgraph.isNewConversation.value=!1,t.langgraph.isLanggraphJustCompleted.value)t.langgraph.isRestoringConversation.value=!1;else{if(t.langgraph.lastRestoredConversationId.value===e.id&&!t.isNewConversation)return console.log("📋 동일한 대화 이미 복원됨 - 스킵:",e.id),void(t.langgraph.isRestoringConversation.value=!1);try{if(t.langgraph.lastRestoredConversationId.value===e.id&&t.langgraph.showLanggraph.value&&t.langgraph.finalAnswer.value)return void(t.langgraph.isRestoringConversation.value=!1);t.langgraph.currentStep.value=0,t.langgraph.originalInput.value="",t.langgraph.augmentedKeywords.value=[],t.langgraph.searchResults.value=[],t.langgraph.finalAnswer.value="",t.langgraph.streamingAnswer.value="",t.langgraph.analysisImageUrl.value="",t.langgraph.isSearching.value=!1,t.langgraph.isGeneratingAnswer.value=!1,t.langgraph.isStreamingAnswer.value=!1,t.langgraph.extractedKeywords.value=null,t.langgraph.extractedDbSearchTitle.value=null;const a=e.messages||[];if(0===a.length)return console.warn("⚠️ 대화 메시지가 비어있습니다. 대화 ID:",e.id),t.langgraph.showLanggraph.value=!1,t.langgraph.isFollowupQuestion.value=!1,console.log("✅ 빈 대화 - isFollowupQuestion을 false로 설정"),t.langgraph.lastRestoredConversationId.value=e.id,void(t.langgraph.isRestoringConversation.value=!1);let o=null;for(const e of a)if("user"===e.role&&("search"===e.q_mode||e.keyword||e.db_contents)){o=e,console.log("✅ LangGraph 메시지 발견:",e.id);break}if(o){if(console.log("✅ LangGraph 메시지 발견:",o.id),t.langgraph.showLanggraph.value=!0,t.langgraph.currentStep.value=4,t.langgraph.originalInput.value=o.question||"",t.langgraph.isFollowupQuestion.value=!0,o.keyword)try{const e="string"===typeof o.keyword?JSON.parse(o.keyword):o.keyword;e&&"object"===typeof e&&!Array.isArray(e)?(e.originalInput&&(t.langgraph.originalInput.value=e.originalInput),e.augmentedKeywords&&(t.langgraph.augmentedKeywords.value=e.augmentedKeywords),e.searchResults&&(t.langgraph.searchResults.value=e.searchResults),e.finalAnswer&&(t.langgraph.finalAnswer.value=e.finalAnswer),e.analysisImageUrl&&(t.langgraph.analysisImageUrl.value=e.analysisImageUrl),e.extractedKeywords&&(t.langgraph.extractedKeywords.value=e.extractedKeywords),e.extractedDbSearchTitle&&(t.langgraph.extractedDbSearchTitle.value=e.extractedDbSearchTitle,t.langgraph.searchedDocuments.value=e.extractedDbSearchTitle)):Array.isArray(e)&&(t.langgraph.augmentedKeywords.value=e.map(((e,t)=>({id:`keyword-${t}`,text:e,category:"augmented"}))),t.langgraph.extractedKeywords.value=e)}catch(s){console.warn("키워드 파싱 실패:",s)}if(o.db_contents)try{const e=JSON.parse(o.db_contents);Array.isArray(e)&&(t.langgraph.searchResults.value=e,t.langgraph.searchedDocuments.value=e.map((e=>e.document_name||"제목 없음")),t.langgraph.extractedDbSearchTitle.value=t.langgraph.searchedDocuments.value,console.log("✅ 검색 결과 복원 완료:",e.length,"건"))}catch(s){console.warn("검색 결과 파싱 실패:",s)}console.log("🔍 답변 복원 시작:",{hasAns:!!o.ans,ansLength:o.ans?o.ans.length:0,currentFinalAnswer:t.langgraph.finalAnswer.value,currentFinalAnswerLength:t.langgraph.finalAnswer.value?t.langgraph.finalAnswer.value.length:0}),o.ans&&""!==o.ans.trim()?(t.langgraph.finalAnswer.value=o.ans,console.log("✅ 답변 복원 완료 (user 메시지 ans 필드에서):",{messageId:o.id,ansLength:o.ans.length,finalAnswerSet:t.langgraph.finalAnswer.value.length})):console.warn("⚠️ user 메시지에 ans가 없습니다:",{messageId:o.id,hasAns:!!o.ans,ansValue:o.ans}),o.image&&!t.langgraph.analysisImageUrl.value&&(t.langgraph.analysisImageUrl.value=o.image,console.log("✅ 분석 이미지 URL 복원 완료")),console.log("✅ 랭그래프 정보 복원 완료:",{showLanggraph:t.langgraph.showLanggraph.value,currentStep:t.langgraph.currentStep.value,hasOriginalInput:!!t.langgraph.originalInput.value,hasFinalAnswer:!!t.langgraph.finalAnswer.value,finalAnswerLength:t.langgraph.finalAnswer.value?t.langgraph.finalAnswer.value.length:0,hasAugmentedKeywords:t.langgraph.augmentedKeywords.value.length>0,hasSearchResults:t.langgraph.searchResults.value.length>0})}else console.log("📭 LangGraph 정보 없음 - 일반 대화로 처리"),t.langgraph.isFollowupQuestion.value=!1,console.log("✅ LangGraph 정보 없음 - isFollowupQuestion을 false로 설정");t.langgraph.lastRestoredConversationId.value=e.id}catch(s){console.error("❌ 랭그래프 정보 복원 실패:",s)}finally{t.langgraph.isRestoringConversation.value=!1}}}function ks(e){if(!e)return"";if(Array.isArray(e)){for(const t of e)if("string"===typeof t&&t.trim())return t.trim();return""}return"string"===typeof e?e.trim():""}async function fs(e,t){try{if(!t.$store.state.currentConversation)return void console.error("⚠️ LangGraph 메시지 저장 실패: 현재 대화가 없습니다.");const a=t.$store.state.currentConversation.id,o=t.langgraph.originalInput.value||"LangGraph 분석 요청";let r="분석 결과가 없습니다.";e.result&&e.result.response?r=e.result.response.answer||e.result.response.final_answer||"분석 결과가 없습니다.":e.response?r=e.response.answer||e.response.final_answer||"분석 결과가 없습니다.":t.langgraph.finalAnswer.value&&(r=t.langgraph.finalAnswer.value);let n=t.langgraph.extractedKeywords.value,i=t.langgraph.extractedDbSearchTitle.value;!n&&e.result&&e.result.keyword&&(n=e.result.keyword),!i&&e.result&&e.result.candidates_total&&(i=e.result.candidates_total.map((e=>e?.res_payload?.document_name||"제목 없음")));let l=t.langgraph.analysisImageUrl.value||"";l="string"===typeof l?l.trim():"",!l&&e.result&&e.result.response&&e.result.response.analysis_image_url?l=e.result.response.analysis_image_url:!l&&e.result&&e.result.analysis_image_url&&(l=e.result.analysis_image_url),"string"===typeof l&&(l=l.trim()),l&&console.log("🖼️ [SAVE] 백엔드 제공 이미지 URL 사용:",l);const c={originalInput:t.langgraph.originalInput.value,augmentedKeywords:t.langgraph.augmentedKeywords.value,searchResults:t.langgraph.searchResults.value.slice(0,5),finalAnswer:r,analysisImageUrl:l,currentStep:t.langgraph.currentStep.value,extractedKeywords:n,extractedDbSearchTitle:i},u=[],g=t.langgraph.searchResults.value||[];if(g&&g.length>0)for(let e=0;e<Math.min(5,g.length);e++){const t=g[e],s=t.res_payload||{},a=s.vector||{};let o="";const r=ks(s.image_url),n=ks(a.image_url);o=r||n,o&&console.log("🖼️ [SAVE] 문서 이미지 추출:",{rank:e+1,document:s.document_name||t.title||"",image:o});const i={rank:e+1,document_name:s.document_name||t.title||"",score:t.res_score||t.score||0,combined_score:t.combined_score||t.res_score||t.score||0,relevance_score:t.res_relevance||0,text:a.text||"",summary_purpose:a.summary_purpose||"",summary_result:a.summary_result||t.summary||"",summary_fb:a.summary_fb||"",image_url:o,res_id:t.res_id||""};u.push(i)}!l&&u.length>0&&(l=u[0].image_url||"",l&&console.log("🖼️ [SAVE] 첫 번째 문서 이미지로 message.image 설정:",l));const d=JSON.stringify(u);console.log("📤 [SAVE] 전송 데이터:",{question:o,q_mode:"search",assistant_response:r,assistant_response_length:r?r.length:0,keyword:c,db_search_title:i,db_contents:u,db_contents_length:u.length,image:l});const h=await fetch(`http://localhost:8000/api/conversations/${a}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({question:o,q_mode:"search",assistant_response:r,skip_llm:!0,keyword:JSON.stringify(c),db_search_title:Array.isArray(i)?JSON.stringify(i):i,db_contents:d,image:l,user_name:t.$store.state.user?.username||"사용자"})});if(h.ok){const e=await h.json();if(console.log("✅ LangGraph 메시지 저장 응답:",e),t.$store.state.currentConversation){const e=o.length>50?o.substring(0,50)+"...":o;try{const s=await fetch(`http://localhost:8000/api/conversations/${a}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({title:e})});s.ok?t.$store.commit("updateConversationTitle",{conversationId:a,title:e}):console.warn("⚠️ 대화 제목 업데이트 실패:",s.status)}catch(s){console.warn("⚠️ 대화 제목 업데이트 중 오류:",s)}}return e}{console.error("❌ LangGraph 메시지 저장 실패:",h.status,h.statusText);const e=await h.text();throw console.error("❌ 오류 응답 내용:",e),new Error(`메시지 저장 실패: ${h.status} ${h.statusText}`)}}catch(a){throw console.error("LangGraph 메시지 저장 중 오류:",a),a}}const ys={name:"HomePage",components:{SearchResultPopup:me,LanggraphContainer:yt,MessageList:Nt,ChatInput:qt},setup(){const e=zt(),t=Wt(),s=Yt(),a=Zt();return{langgraph:e,messages:t,sse:s,scroll:a}},data(){return{showSearchResultPopup:!1,selectedSearchResult:null,isNewConversation:!1,isPopupChanging:!1}},computed:{...(0,o.aH)(["conversations","currentConversation","isStreaming","streamingMessage"]),currentMessages(){const e=this.$store.state.currentConversation;return e&&e.messages?e.messages:[]},progressPercentage(){return this.langgraph.currentStep.value/4*100}},methods:{async saveLangGraphMessage(e){await fs(e,this)},scrollToLanggraph(){this.scroll?.scrollToLanggraph()},async sendChatMessage(){if(!this.$refs.chatInput.userInput.trim()||this.messages.isLoading.value||this.$store.state.isStreaming)return;const e=this.$refs.chatInput.userInput.trim();this.$refs.chatInput.clearInput();const t=this.$store.state.currentConversation?.id||null;try{this.langgraph.isFollowupQuestion.value?await vs(e,t,this):await us(e,this),this.$nextTick((()=>{this.scroll?.scrollToBottom(this.$refs.chatMessages),this.scroll?.safeFocus(this.$refs.chatInput?.$refs?.inputField)}))}catch(s){console.error("Error sending message:",s),this.messages.isLoading.value=!1,this.langgraph.isSearching.value=!1}},async submitFeedback(e,t){const s=this.currentMessages.find((t=>t.id===e));if(s){console.log("👍 피드백 처리 시작:",{messageId:e,feedback:t,currentFeedback:s.feedback});try{await this.$store.dispatch("submitFeedback",{messageId:e,feedback:t}),console.log("✅ 피드백 처리 완료")}catch(a){console.error("❌ 피드백 처리 실패:",a)}}else console.warn("⚠️ 피드백 처리 실패: 메시지를 찾을 수 없음",e)},handleInputChange(){this.$refs.chatInput&&this.$refs.chatInput.adjustTextareaHeight&&this.$refs.chatInput.adjustTextareaHeight()},openSearchResultPopup(e){this.isPopupChanging=!0,this.selectedSearchResult=e,this.showSearchResultPopup=!0,this.$nextTick((()=>{setTimeout((()=>{this.isPopupChanging=!1}),100)}))},closeSearchResultPopup(){this.isPopupChanging=!0,this.showSearchResultPopup=!1,this.selectedSearchResult=null,this.$nextTick((()=>{setTimeout((()=>{this.isPopupChanging=!1}),100)}))},async newConversation(){if(this.isCreatingConversation)console.log("[HOME] 새 대화 생성 중 - 중복 실행 방지");else{this.isCreatingConversation=!0,this.isNewConversation=!0,this.isFirstQuestionInSession=!0,this.isRestoringConversation=!1,this.langgraph.isFollowupQuestion.value=!1,console.log("✅ 새 대화 생성 - isFollowupQuestion을 false로 설정"),this.userInput="",this.langgraph.resetLanggraphState(),this.finalAnswer="",this.searchResults=[],this.extractedKeywords=null,this.extractedDbSearchTitle=null,this.lastRestoredConversationId=null,this.lastRestoredMessageCount=0,this.langgraph.lastRestoredConversationId.value=null;try{const e=await this.$store.dispatch("createConversation");e?(this.$store.commit("setCurrentConversation",e),console.log("✅ 새 대화 생성 완료:",e.id)):(console.error("❌ 새 대화 생성 실패"),alert("새 대화 생성에 실패했습니다. 다시 시도해주세요."))}catch(e){console.error("❌ 새 대화 생성 오류:",e),alert("새 대화 생성 중 오류가 발생했습니다.")}this.isCreatingConversation=!1,setTimeout((()=>{this.isNewConversation=!1,this.scroll?.scrollToBottom(this.$refs.chatMessages),this.scroll?.safeFocus(this.$refs.chatInput?.$refs?.inputField)}),100)}},async refreshToken(){try{const e=await fetch("http://localhost:8000/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`}});if(e.ok){const t=await e.json();return this.$store.commit("setToken",t.access_token),!0}throw console.error("❌ 토큰 갱신 실패:",e.status),new Error("토큰 갱신 실패")}catch(e){throw console.error("❌ 토큰 갱신 중 오류:",e),e}},openImageInNewTab(e){if(e)try{window.open(e,"_blank","noopener,noreferrer")}catch(t){console.error("이미지 열기 실패:",t);try{window.location.href=e}catch(s){console.error("대체 방법도 실패:",s)}}else console.warn("이미지 URL이 없습니다")},preserveScrollPosition(){const e=this.$refs.chatMessages;e&&(this.lastScrollPosition=e.scrollTop)}},beforeUnmount(){},mounted(){this.$nextTick((()=>{this.scroll?.safeFocus(this.$refs.chatInput?.$refs?.inputField),this.scroll?.adjustTextareaHeight(this.$refs.chatInput?.$refs?.inputField)})),this.$store.state.loginNewConversation&&(this.newConversation(),this.$store.commit("setLoginNewConversation",!1))},updated(){this.isPopupChanging||this.scroll?.scrollToBottom(this.$refs.chatMessages)},watch:{showSearchResultPopup(){},"$store.state.streamingMessage"(){this.scroll&&!this.scroll.scrollThrottled.value&&(this.scroll.scrollThrottled.value=!0,this.scroll.scrollToBottom(this.$refs.chatMessages),setTimeout((()=>{this.scroll&&(this.scroll.scrollThrottled.value=!1)}),500))},"$store.state.currentConversation"(e){this.langgraph.isLanggraphJustCompleted.value?console.log("✅ 랭그래프 완료 직후 - watcher 완전 스킵하여 상태 유지"):(this.$store.state.conversationRestored&&(this.isNewConversation=!1,this.isFirstQuestionInSession=!1,this.$store.commit("setConversationRestored",!1)),this.isNewConversation?this.$nextTick((()=>{this.scroll?.scrollToBottom(this.$refs.chatMessages)})):this.$nextTick((()=>{this.scroll?.scrollToBottom(this.$refs.chatMessages),e&&(e.messages&&e.messages.length>0?(console.log("🔄 기존 대화 선택 - 랭그래프 복원 시작 (메시지 있음)"),setTimeout((async()=>{await ws(e,this),this.$forceUpdate(),this.$nextTick((()=>{this.scroll?.scrollToBottom(this.$refs.chatMessages)}))}),0)):(console.log("🔄 메시지 없음 - API로 메시지 가져오기:",e.id),setTimeout((async()=>{try{const t=await fetch(`http://localhost:8000/api/conversations/${e.id}/messages`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`,"Content-Type":"application/json"},credentials:"include"});if(t.ok){const s=await t.json();console.log("✅ 메시지 가져오기 성공:",s.messages?.length||0,"개");const a={...e,messages:s.messages||[]};this.$store.state.currentConversation.messages=s.messages||[],await ws(a,this),this.$forceUpdate(),this.$nextTick((()=>{this.scroll?.scrollToBottom(this.$refs.chatMessages)}))}else console.error("❌ 메시지 가져오기 실패:",t.status)}catch(t){console.error("❌ 메시지 가져오기 오류:",t)}}),0)))})))},"$store.state.shouldScrollToBottom"(e){e&&(this.scroll?.scrollToBottom(this.$refs.chatMessages),this.$store.commit("setShouldScrollToBottom",!1))},"$store.state.isStreaming"(e){e?this.$nextTick((()=>{this.streamingVisible=!0,this.$refs.streamingText&&(this.observer||(this.observer=new ResizeObserver((()=>{this.scroll?.scrollToBottom(this.$refs.chatMessages)}))),this.observer.observe(this.$refs.streamingText))})):(this.streamingVisible=!1,this.observer&&(this.observer.disconnect(),this.observer=null),this.scroll?.scrollToBottom(this.$refs.chatMessages))},"$store.state._newConversationTrigger"(e,t){e&&e!==t&&(console.log("[HOME] 새 대화 트리거 감지:",e),this.langgraph.resetLanggraphState(),this.newConversation())},currentMessages(e){e&&0!==e.length||(this.langgraph.showLanggraph.value=!1)}},beforeDestroy(){this.scrollTimeout&&(clearTimeout(this.scrollTimeout),this.scrollTimeout=null),this.observer&&(this.observer.disconnect(),this.observer=null)}},Ss=(0,H.A)(ys,[["render",Z]]),Cs=Ss,_s={class:"redirect-page"};function Is(e,t,s,a,o,r){return(0,n.uX)(),(0,n.CE)("div",_s,t[0]||(t[0]=[(0,n.Lk)("p",null,"This view is no longer used. Redirecting to home...",-1)]))}const bs={name:"ChatHistoryPage",mounted(){this.$router.push("/")}},Ls=(0,H.A)(bs,[["render",Is],["__scopeId","data-v-6d3a68ba"]]),As=Ls;async function $s(e,t){try{sessionStorage.setItem("oauth_processing","true"),sessionStorage.removeItem("sso_processed");const o=`id_token=${encodeURIComponent(e)}&state=${encodeURIComponent(t)}`,r=await fetch("http://localhost:8000/api/auth/acs",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o,credentials:"include"});if(!r.ok)throw new Error(`OAuth processing failed: ${r.status}`);try{const e=await r.text();window.history.replaceState({},document.title,window.location.pathname);try{const t=JSON.parse(e);if(t.success&&t.user){if(!t.access_token)throw new Error("백엔드 인증 실패");Ds.commit("setAuth",{token:t.access_token,user:{username:t.user.username,email:t.user.mail,loginid:t.user.loginid,deptname:t.user.deptname,id:t.user.userid}}),localStorage.setItem("access_token",t.access_token),localStorage.setItem("user_info",JSON.stringify(t.user));try{await Ds.dispatch("fetchConversations")}catch(s){console.error("[AUTH] 대화 목록 가져오기 실패:",s)}return Ks=!0,Ns=!1,sessionStorage.setItem("sso_processed","true"),sessionStorage.removeItem("oauth_processing"),void setTimeout((()=>{js&&js.push&&js.push("/").then((()=>{setTimeout((()=>{sessionStorage.setItem("sso_processed","true"),sessionStorage.removeItem("oauth_processing")}),500)})).catch((e=>{console.error("[AUTH] 홈페이지 이동 실패:",e);try{window.location.href="/"}catch(t){console.error("[AUTH] URL 변경도 실패:",t)}}))}),200)}}catch(a){setTimeout((()=>{const e=Es(),t=Os();if(e&&t)try{return Ds.commit("setAuth",{token:e,user:t}),Ds.dispatch("fetchConversations").then((()=>{})).catch((e=>{console.error("[AUTH] localStorage 복원 후 대화 목록 가져오기 실패:",e)})),void(window.location.href="/")}catch(s){window.location.reload()}else window.location.reload()}),100)}}catch(s){window.location.reload()}}catch(s){window.history.replaceState({},document.title,window.location.pathname),sessionStorage.removeItem("oauth_processing"),sessionStorage.removeItem("sso_processed"),Ns=!1,Ks=!1,console.error("[AUTH] processOAuthToken 오류:",s),setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(e){console.error("[AUTH] SSO 리다이렉트 실패:",e)}}),1e3)}}function Ts(){const e=window.location.hash;if(e&&e.includes("id_token=")){const t=new URLSearchParams(e.substring(1)),s=t.get("id_token"),a=t.get("state");if(s&&a)return $s(s,a),!0}const t=new URLSearchParams(window.location.search),s=t.get("auth_success"),a=t.get("user");if("true"===s&&a){window.history.replaceState({},document.title,window.location.pathname);const e=Es(),t=Os();if(e&&t)try{Ds.commit("setAuth",{token:e,user:t})}catch(o){console.error("[AUTH] SSO 콜백 사용자 정보 설정 실패:",o)}return!0}return!1}function Es(){return localStorage.getItem("access_token")||localStorage.getItem("auth_token")}function Rs(e){if(!e)return null;if("object"===typeof e)return e;try{return JSON.parse(e)}catch(t){const s={},a=e.split("&");for(const e of a)if(e.includes("=")){const[t,a]=e.split("=",2);s[t]=decodeURIComponent(a||"")}return Object.keys(s).length>0?s:null}}function xs(e){const t=Rs(e);if(!t)return null;const s=t.userid||t.id||t.user_id||t.sub||t.loginid||null;if(!s)return console.error("[AUTH] 사용자 ID를 확인할 수 없습니다."),null;const a=t.mail||t.email||"",o=t.username||t.name||t.loginid||t.loginId||(a?a.split("@")[0]:`user-${s}`),r=t.loginid||t.loginId||s,n=t.deptname||t.department||t.dept||"";return{...t,username:o,mail:t.mail||a,email:a,loginid:r,deptname:n,id:s,userid:s}}function Os(){const e=localStorage.getItem("user_info")||localStorage.getItem("user");return xs(e)}const Us=Es()||"",Ms=Os();function Ps(){const e=Es(),t=Os();if(e&&t)try{"undefined"!==typeof Ds&&Ds.commit&&(Ds.commit("setAuth",{token:e,user:t}),fetch("http://localhost:8000/api/auth/me",{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json",Accept:"application/json"},credentials:"include"}).then((e=>{e.ok||(localStorage.removeItem("access_token"),localStorage.removeItem("user_info"),localStorage.removeItem("auth_token"),localStorage.removeItem("user"),"undefined"!==typeof Ds&&Ds.commit&&Ds.commit("clearAuth"))})).catch((e=>{console.error("Token validation error:",e),"TypeError"===e.name&&e.message.includes("fetch")?console.error("[MAIN] 네트워크 오류 - 백엔드 서버 연결 실패"):"undefined"!==typeof Ds&&Ds.commit&&Ds.commit("clearAuth")})))}catch(s){console.error("Error restoring auth from storage:",s),localStorage.removeItem("access_token"),localStorage.removeItem("user_info"),localStorage.removeItem("auth_token"),localStorage.removeItem("user"),"undefined"!==typeof Ds&&Ds.commit&&Ds.commit("clearAuth")}}const Ds=(0,o.y$)({state(){return{conversations:[],currentConversation:null,feedbackUpdateTrigger:0,llamaApiKey:localStorage.getItem("llama_api_key")||"",llamaApiBase:localStorage.getItem("llama_api_base")||"",llamaApiEndpoint:localStorage.getItem("llama_api_endpoint")||"/llama4/1/llama/aiserving/llama-4/maverick/v1/completions",llamaApiSet:!!localStorage.getItem("llama_api_key"),llamaApiError:null,token:Us,user:Ms,isAuthenticated:!(!Us||!Ms),isStreaming:!1,streamingMessage:"",shouldScrollToBottom:!1,conversationRestored:!1,loginNewConversation:!1}},mutations:{setConversations(e,t){e.conversations=Array.isArray(t)?t:[]},addConversation(e,t){Array.isArray(e.conversations)||(e.conversations=[]),e.conversations.unshift(t)},setNewConversationTrigger(e){e._newConversationTrigger=Date.now()},removeConversation(e,t){Array.isArray(e.conversations)?(e.conversations=e.conversations.filter((e=>e.id!==t)),e.currentConversation&&e.currentConversation.id===t&&(e.currentConversation=e.conversations.length>0?e.conversations[0]:null)):e.conversations=[]},updateConversationTitle(e,{conversationId:t,title:s}){if(Array.isArray(e.conversations)){const a=e.conversations.find((e=>e.id===t));a&&(a.title=s)}e.currentConversation&&e.currentConversation.id===t&&(e.currentConversation.title=s)},setCurrentConversation(e,t){e.currentConversation=t,t&&t.id?sessionStorage.setItem("currentConversationId",t.id.toString()):sessionStorage.removeItem("currentConversationId"),e._conversationUpdateTrigger=Date.now()},addMessage(e,{conversationId:t,message:s}){if(!Array.isArray(e.conversations))return;const a=e.conversations.find((e=>e.id===t));a&&(Array.isArray(a.messages)||(a.messages=[]),a.messages.push(s))},addMessageToCurrentConversation(e,t){e.currentConversation&&(Array.isArray(e.currentConversation.messages)||(e.currentConversation.messages=[]),e.currentConversation.messages.push(t))},updateMessageAnswer(e,{messageId:t,answer:s}){if(console.log("🔍 [DEBUG] updateMessageAnswer mutation 호출:",{messageId:t,answerLength:s?.length}),e.currentConversation&&Array.isArray(e.currentConversation.messages)){const a=e.currentConversation.messages.find((e=>e.id===t||e.backend_id===t));a?(console.log("🔍 [DEBUG] 메시지 찾음, ans 필드 업데이트:",a.id),a.ans=s,console.log("🔍 [DEBUG] 메시지 업데이트 완료")):console.warn("⚠️ updateMessageAnswer: 메시지를 찾을 수 없음:",t)}else console.warn("⚠️ updateMessageAnswer: currentConversation 또는 messages가 없음")},updateMessageId(e,{tempId:t,realId:s,additionalData:a}){if(e.currentConversation&&Array.isArray(e.currentConversation.messages)){const o=e.currentConversation.messages.find((e=>e.id===t));o?(o.id=s,a&&Object.assign(o,a),console.log(`✅ 메시지 ID 업데이트 완료: ${t} → ${s}`)):console.warn(`⚠️ 업데이트할 메시지를 찾을 수 없음: ${t}`)}},updateMessageContent(e,{messageId:t,content:s,image:a}){if(e.currentConversation&&Array.isArray(e.currentConversation.messages)){const o=e.currentConversation.messages.find((e=>e.id===t));o?(o.ans=s,a&&(o.image=a),console.log(`✅ 메시지 내용 업데이트 완료: ${t}`)):console.warn(`⚠️ 업데이트할 메시지를 찾을 수 없음: ${t}`)}},updateFeedback(e,{conversationId:t,messageId:s,feedback:a}){const o=e.conversations.find((e=>e.id===t));if(!o)return;const r=o.messages.findIndex((e=>e.id===s));if(-1===r)return;const n={...o.messages[r],feedback:a};if(o.messages.splice(r,1,n),e.currentConversation&&e.currentConversation.id===t){const t=e.currentConversation.messages.findIndex((e=>e.id===s));-1!==t&&e.currentConversation.messages.splice(t,1,n)}e.feedbackUpdateTrigger=(e.feedbackUpdateTrigger||0)+1,console.log("✅ 피드백 상태 업데이트:",{messageId:s,feedback:a,trigger:e.feedbackUpdateTrigger,currentConversationId:e.currentConversation?.id,conversationId:t})},setApiKeyError(e,t){e.apiKeyError=t},setAuth(e,{token:t,user:s}){if(t&&3===t.split(".").length)try{const e=JSON.parse(atob(t.split(".")[0]));if("HS256"!==e.alg)return void console.error("[AUTH] 오류: HS256이 아닌 토큰은 허용되지 않음:",e.alg)}catch(i){}if(t&&3===t.split(".").length)try{const e=JSON.parse(atob(t.split(".")[0]));if("HS256"!==e.alg)return void console.error("[AUTH] 토큰 설정이 차단되었습니다. 백엔드 JWT 토큰만 사용 가능합니다.")}catch(i){return}else if(t&&"oauth_token"!==t)return;const a=xs(s);if(!a)return void console.error("[AUTH] 유효하지 않은 사용자 정보로 인해 인증 상태를 설정할 수 없습니다.");const o=e.user?e.user.id||e.user.loginid:null,r=a?a.id||a.loginid:null,n=o&&r&&o!==r;n&&(e.conversations=[],e.currentConversation=null),e.token=t,e.user=a,e.isAuthenticated=!!t,localStorage.setItem("access_token",t),localStorage.setItem("user_info",JSON.stringify(a)),localStorage.setItem("auth_token",t),localStorage.setItem("user",JSON.stringify(a))},setUser(e,t){e.user=t,localStorage.setItem("user",JSON.stringify(t)),localStorage.setItem("user_info",JSON.stringify(t))},clearAuth(e){e.token="",e.user=null,e.isAuthenticated=!1,e.loginNewConversation=!1,localStorage.removeItem("auth_token"),localStorage.removeItem("user"),localStorage.removeItem("access_token"),localStorage.removeItem("user_info"),document.cookie="auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",document.cookie="access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",document.cookie="user_info=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"},setIsStreaming(e,t){e.isStreaming=t},updateStreamingMessage(e,t){e.streamingMessage=t},clearStreamingMessage(e){e.streamingMessage=""},addStreamingMessageToConversation(e,{conversationId:t,message:s}){const a=e.conversations.find((e=>e.id===t));a&&a.messages.push(s),e.streamingMessage="",e.isStreaming=!1},setShouldScrollToBottom(e,t){e.shouldScrollToBottom=t},setConversationRestored(e,t){e.conversationRestored=t},setLoginNewConversation(e,t){e.loginNewConversation=t}},actions:{handleAuthError({commit:e}){e("clearAuth"),e("setConversations",[]),e("setCurrentConversation",null)},async register(e,t){const s=await fetch("http://localhost:8000/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const e=await s.json();throw new Error(e.detail||"Registration failed")}return await this.dispatch("login",{username:t.username,password:t.password})},async login({commit:e,dispatch:t},{username:s,password:a}){const o=new FormData;o.append("username",s),o.append("password",a);const r=await fetch("http://localhost:8000/api/auth/token",{method:"POST",body:o});if(!r.ok){const e=await r.json();throw new Error(e.detail||"Login failed")}const n=await r.json(),i=await fetch("http://localhost:8000/api/auth/me",{headers:{Authorization:`Bearer ${n.access_token}`}});if(!i.ok)throw new Error("Failed to get user information");const l=await i.json();return e("setAuth",{token:n.access_token,user:l}),e("setConversations",[]),e("setCurrentConversation",null),e("setLoginNewConversation",!0),await t("fetchConversations"),!0},logout({commit:e}){e("clearAuth"),e("setConversations",[]),e("setCurrentConversation",null),e("setLoginNewConversation",!1),Fs()},async fetchConversations({commit:e,state:t}){try{if(!t.isAuthenticated)return e("setConversations",[]),void e("setCurrentConversation",null);const s={},a=localStorage.getItem("access_token");a&&(s["Authorization"]=`Bearer ${a}`);const o=await fetch("http://localhost:8000/api/conversations",{headers:s,credentials:"include"});if(!o.ok){if(401===o.status)return void e("clearAuth");throw new Error(`Error: ${o.status} ${o.statusText}`)}const r=await o.json();r.forEach((e=>{e.messages.forEach((()=>{}))}));let n=t.currentConversation?t.currentConversation.id:null;if(!n){const e=sessionStorage.getItem("currentConversationId");e&&(n=parseInt(e,10))}if(e("setConversations",r),t.loginNewConversation)e("setCurrentConversation",null),sessionStorage.removeItem("currentConversationId");else if(n&&r.length>0){const s=r.find((e=>e.id===n));if(s)if(t.currentConversation&&t.currentConversation.messages&&t.currentConversation.messages.length>0){console.log("✅ 기존 메시지 보존:",t.currentConversation.messages.length,"개");const a={...s,messages:t.currentConversation.messages};e("setCurrentConversation",a),console.log("✅ 대화 정보 업데이트 완료 (메시지 보존):",n)}else e("setCurrentConversation",s),console.log("✅ 기존 대화 복원 완료:",n);else e("setCurrentConversation",r[0]),sessionStorage.setItem("currentConversationId",r[0].id)}else!t.currentConversation&&r.length>0&&(e("setCurrentConversation",r[0]),sessionStorage.setItem("currentConversationId",r[0].id))}catch(s){e("setConversations",[])}},async createConversation({commit:e,state:t}){try{if(!t.isAuthenticated)return console.error("[STORE] 인증되지 않음 - 대화 생성 불가"),null;const s=localStorage.getItem("access_token");if(!s)return console.error("[STORE] JWT 토큰 없음 - 대화 생성 불가"),null;const a={"Content-Type":"application/json",Authorization:`Bearer ${s}`},o=new AbortController,r=setTimeout((()=>o.abort()),5e3),n=await fetch("http://localhost:8000/api/conversations",{method:"POST",headers:a,credentials:"include",signal:o.signal});if(clearTimeout(r),!n.ok){if(401===n.status)return console.error("[STORE] 인증 실패 - 로그아웃 처리"),e("clearAuth"),null;throw new Error(`HTTP ${n.status}: ${n.statusText}`)}const i=await n.json();return Array.isArray(t.conversations)||e("setConversations",[]),e("addConversation",i),i}catch(s){return"AbortError"===s.name?console.error("[STORE] 대화 생성 타임아웃"):console.error("[STORE] 대화 생성 오류:",s),null}},async deleteConversation({commit:e,state:t},s){try{if(!t.isAuthenticated)return;const a=await fetch(`http://localhost:8000/api/conversations/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("access_token")}`},credentials:"include"});if(401===a.status)return void e("clearAuth");a.ok&&e("removeConversation",s)}catch(a){console.error("Error deleting conversation:",a)}},async sendMessage({commit:e,state:t},{text:s}){try{if(!t.isAuthenticated)return;if(!t.currentConversation)return void console.error("⚠️ 메시지 전송 실패: 현재 대화가 없습니다.");const a=await fetch(`http://localhost:8000/api/conversations/${t.currentConversation.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({question:s}),credentials:"include"}),o=await a.json();return e("addMessage",{conversationId:t.currentConversation.id,message:o.userMessage}),e("addMessage",{conversationId:t.currentConversation.id,message:o.assistantMessage}),o}catch(a){console.error("Error sending message:",a)}},async submitFeedback({commit:e,state:t},{messageId:s,feedback:a}){try{if(!t.isAuthenticated)return;const r=t.currentConversation;if(!r)return;const n=r.messages.find((e=>e.id===s));if(!n)return void console.error("메시지를 찾을 수 없습니다:",s);const i=n.feedback===a?null:a,l=n.feedback;e("updateFeedback",{conversationId:t.currentConversation.id,messageId:s,feedback:i});const c=t.currentConversation.messages.find((e=>e.id===s));c&&(c.feedback=i);const u={feedback:i};let g;if(n.backend_id?(g=n.backend_id,console.log("✅ backend_id 사용:",g)):(g=String(s).replace("-assistant",""),console.log("⚠️ fallback ID 사용:",g)),isNaN(g))return console.error("유효하지 않은 메시지 ID:",s,"backend_id:",n.backend_id),void alert("메시지 ID가 유효하지 않습니다.");const d=await fetch(`http://localhost:8000/api/messages/${g}/feedback`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify(u),credentials:"include"});if(!d.ok){if(e("updateFeedback",{conversationId:t.currentConversation.id,messageId:s,feedback:l}),401===d.status)return void e("clearAuth");const a=await d.text();let r;try{r=JSON.parse(a)}catch(o){r={detail:a}}throw console.error("피드백 제출 실패:",{status:d.status,messageId:g,originalMessageId:s,backend_id:n.backend_id,error:r.detail||a}),new Error(`Failed to submit feedback: ${r.detail||a}`)}console.log("✅ 피드백 업데이트 완료:",{messageId:s,feedback:i})}catch(r){r.message.includes("세션이 만료")||alert(`피드백 전송 중 오류가 발생했습니다: ${r.message}`)}},async sendStreamingMessage({commit:e,state:t},{text:s}){try{if(!t.isAuthenticated)return;if(!t.currentConversation)return void console.error("⚠️ 스트리밍 메시지 전송 실패: 현재 대화가 없습니다.");const i=t.currentConversation.id,l=await fetch(`http://localhost:8000/api/conversations/${i}/messages/prepare`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({question:s,conversation_id:i}),credentials:"include"});if(!l.ok){if(401===l.status)return void await this.dispatch("handleAuthError");throw new Error(`Prepare message failed: ${l.status}`)}const c=await l.json();console.log("✅ 영구 메시지 ID 발급 완료:",c);const u={id:`${c.userMessage.id}-user`,conversation_id:i,role:"user",question:s,ans:"",created_at:(new Date).toISOString(),backend_id:c.userMessage.id};e("addMessage",{conversationId:i,message:u}),e("setIsStreaming",!0),e("clearStreamingMessage");try{const n=await fetch("http://localhost:8000/api/stream",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({question:s,conversation_id:i}),credentials:"include"});if(!n.ok){if(401===n.status)return e("setIsStreaming",!1),void e("clearAuth");throw new Error(`Server responded with ${n.status}: ${n.statusText}`)}const l=n.body.getReader(),g=new TextDecoder;let d="",h=null,p=!0;while(p){const{value:t,done:s}=await l.read();if(s){p=!1;break}const r=g.decode(t),n=r.split("\n\n");for(const i of n)if(i.startsWith("data: ")){const t=i.substring(6);if("[DONE]"===t){p=!1;try{const t=await fetch(`http://localhost:8000/api/messages/${c.assistantMessage.id}/complete`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({assistant_response:d,image_url:h}),credentials:"include"});t.ok?(console.log("✅ 메시지 완료 처리 성공"),e("updateMessageContent",{messageId:`${c.assistantMessage.id}-assistant`,content:d,image:h})):console.warn("⚠️ 메시지 완료 처리 실패:",t.status)}catch(a){console.warn("⚠️ 메시지 완료 처리 오류:",a)}break}try{const s=JSON.parse(t);s.text&&(d+=s.text,e("updateStreamingMessage",d)),s.image_url&&(h=s.image_url)}catch(o){d+=t,e("updateStreamingMessage",d)}}}try{const e=await fetch(`http://localhost:8000/api/conversations/${i}/messages/stream`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("access_token")}`},body:JSON.stringify({question:s,assistant_response:d,image_url:h}),credentials:"include"});if(e.ok){const s=await e.json(),a=t.conversations.find((e=>e.id===i));if(a&&a.messages){const e=a.messages.findIndex((e=>e.id===u.id&&"user"===e.role));-1!==e&&(a.messages[e].id=s.userMessage.id)}}else if(401===e.status)return void await this.dispatch("handleAuthError")}catch(r){console.warn("Failed to save message to backend, but UI was updated:",r)}return{userMessage:u}}catch(n){console.error("Streaming error:",n);const e=t.conversations.find((e=>e.id===i))?.messages?.filter((e=>"user"===e.role))||[];if(e.length>0){const t=e[e.length-1];t.ans="죄송합니다. 메시지를 처리하는 중 오류가 발생했습니다. 다시 시도해 주세요."}return{userMessage:u}}}catch(i){console.error("Error in streaming message:",i),e("setIsStreaming",!1)}}}});setTimeout((()=>{const e=window.location.href;e.includes("id_token")||e.includes("code=")||e.includes("state=")||performance.navigation.type!==performance.navigation.TYPE_RELOAD&&performance.navigation.type!==performance.navigation.TYPE_NAVIGATE||Fs(),Ps(),Ts()}),0);let Ns=!1,Ks=!1;function Fs(){Ns=!1,Ks=!1,sessionStorage.removeItem("oauth_processing"),sessionStorage.removeItem("sso_processed")}const Bs=(e,t,s)=>{if("/oauth_callback"===e.path)return void s();if(Ns){let e=0;const t=15,a=()=>{if(e++,!Ns||e>=t){e>=t&&(Ns=!1,sessionStorage.removeItem("oauth_processing"));const a=localStorage.getItem("access_token"),o=localStorage.getItem("user_info");a&&o&&Ds.state.isAuthenticated?s():(s(!1),setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(e){try{window.location.href="http://localhost:8000/api/auth/auth_sh"}catch(t){console.error("SSO 리다이렉트 실패:",t)}}}),100))}else setTimeout(a,200)};return void a()}if(Ds.state.isAuthenticated&&Ds.state.token)return void s();const a=localStorage.getItem("access_token"),o=localStorage.getItem("user_info");if(a&&o)try{const e=JSON.parse(o);return Ds.commit("setAuth",{token:a,user:e}),void s()}catch(u){console.error("Stored user info parsing error:",u),localStorage.removeItem("access_token"),localStorage.removeItem("user_info")}const r=new URLSearchParams(window.location.search),n=r.get("token"),i=window.location.hash;if(n||i&&i.includes("id_token"))return Ns=!0,void s();const l="true"===sessionStorage.getItem("sso_processed"),c="true"===sessionStorage.getItem("oauth_processing");if(l||c){const e=localStorage.getItem("access_token"),t=localStorage.getItem("user_info");if(e&&t){try{const s=JSON.parse(t);Ds.commit("setAuth",{token:e,user:s})}catch(u){console.error("User info parsing error:",u)}return void s()}{let e=0;const t=6,a=()=>{e++;const o=localStorage.getItem("access_token"),r=localStorage.getItem("user_info");if(o&&r){try{const e=JSON.parse(r);Ds.commit("setAuth",{token:o,user:e})}catch(u){console.error("User info parsing error:",u)}s()}else e>=t?(sessionStorage.removeItem("oauth_processing"),sessionStorage.removeItem("sso_processed"),s(!1),setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(u){try{window.location.href="http://localhost:8000/api/auth/auth_sh"}catch(e){console.error("SSO 리다이렉트 실패:",e)}}}),100)):setTimeout(a,500)};return void setTimeout(a,500)}}s(!1),setTimeout((()=>{try{window.location.replace("http://localhost:8000/api/auth/auth_sh")}catch(u){try{window.location.href="http://localhost:8000/api/auth/auth_sh"}catch(e){alert("로그인이 필요합니다. 수동으로 로그인 페이지로 이동해주세요.")}}}),100)},js=(0,r.aE)({history:(0,r.LA)(),routes:[{path:"/",component:Cs},{path:"/history",component:As},{path:"/admin",component:Cs},{path:"/oauth_callback",redirect:e=>{const t=e.hash||e.query.hash||window.location.hash;if(t){const e=new URLSearchParams(t.substring(1)),a=e.get("access_token"),o=e.get("id_token");if(a&&o)try{const e=o.split(".")[1],t=e.replace(/-/g,"+").replace(/_/g,"/"),s=decodeURIComponent(atob(t).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join("")),a=JSON.parse(s),r={username:a.name||"User",mail:a.email||"",deptname:a.deptname||"",loginid:a.sub,id:a.sub};fetch("http://localhost:8000/api/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r.username,id_token:o,is_sso:!0})}).then((e=>e.ok?e.json():e.json().then((e=>{throw console.warn("Backend authentication failed:",e),new Error(e.detail||"Backend authentication failed")})))).then((e=>{const t=e.user||r;Ds.commit("setAuth",{token:e.access_token,user:t}),localStorage.setItem("access_token",e.access_token),localStorage.setItem("user_info",JSON.stringify(t))})).catch((e=>{console.error("Backend authentication failed:",e),alert("백엔드 인증에 실패했습니다. 다시 시도해주세요.")})).finally((()=>{Ds.commit("setConversations",[]),Ds.commit("setCurrentConversation",null),Ds.dispatch("fetchConversations").catch((e=>{console.error("대화 가져오기 실패:",e)})).finally((()=>{Ns=!1,Ks=!0,sessionStorage.setItem("sso_processed","true"),sessionStorage.removeItem("oauth_processing"),Ds.state.isAuthenticated&&localStorage.getItem("access_token")&&js.push("/")}))}))}catch(s){Ns=!1}}return"/"}}]}),Qs=()=>{const e="true"===sessionStorage.getItem("logout_redirect");if(e)return void sessionStorage.removeItem("logout_redirect");if(Ks)return;"true"===sessionStorage.getItem("oauth_processing")&&sessionStorage.removeItem("oauth_processing"),Ns=!0;const t=new URLSearchParams(window.location.search),s=t.get("token");if(window.location.hash){const e=new URLSearchParams(window.location.hash.substring(1)),t=e.get("id_token"),s=e.get("state");if(t&&s){sessionStorage.setItem("oauth_processing","true"),sessionStorage.removeItem("sso_processed");const e=new URL(window.location);return e.hash="",window.history.replaceState({},document.title,e),$s(t,s),Ks=!0,void(Ns=!1)}}if(s){const e=new URL(window.location);e.search="",window.history.replaceState({},document.title,e),Ks?Ns=!1:Ds.dispatch("loginWithToken",s).then((()=>{Ks=!0,Ns=!1,js.push("/")})).catch((e=>{console.error("Auto-login failed:",e),Ns=!1,js.push("/login")}))}else Ns=!1};js.beforeEach(((e,t,s)=>{if("/oauth_callback"===e.path)return void s();const a=["/","/history","/admin"];a.includes(e.path)?Bs(e,t,s):s()})),Qs();const Js=(0,a.Ef)(q);Js.use(Ds),Js.use(js);Js.mount("#app")}},t={};function s(a){var o=t[a];if(void 0!==o)return o.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,s),r.exports}s.m=e,(()=>{var e=[];s.O=(t,a,o,r)=>{if(!a){var n=1/0;for(u=0;u<e.length;u++){for(var[a,o,r]=e[u],i=!0,l=0;l<a.length;l++)(!1&r||n>=r)&&Object.keys(s.O).every((e=>s.O[e](a[l])))?a.splice(l--,1):(i=!1,r<n&&(n=r));if(i){e.splice(u--,1);var c=o();void 0!==c&&(t=c)}}return t}r=r||0;for(var u=e.length;u>0&&e[u-1][2]>r;u--)e[u]=e[u-1];e[u]=[a,o,r]}})(),(()=>{s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})}})(),(()=>{s.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})(),(()=>{s.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}})(),(()=>{var e={524:0};s.O.j=t=>0===e[t];var t=(t,a)=>{var o,r,[n,i,l]=a,c=0;if(n.some((t=>0!==e[t]))){for(o in i)s.o(i,o)&&(s.m[o]=i[o]);if(l)var u=l(s)}for(t&&t(a);c<n.length;c++)r=n[c],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(u)},a=self["webpackChunkllm_mini_frontend"]=self["webpackChunkllm_mini_frontend"]||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})();var a=s.O(void 0,[504],(()=>s(518)));a=s.O(a)})();
//# sourceMappingURL=app.939fa8aa.js.map